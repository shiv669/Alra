(()=>{"use strict";if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.getURL){const e=chrome.runtime.getURL("/");console.log("âœ… ALRA: Webpack public path set to:",e)}else console.warn("âš ï¸ ALRA: chrome.runtime.getURL not available, chunks may not load correctly");class e{constructor(e){this.modal=null,this.overlay=null,this.isVisible=!1,this.config=e,this.createModal(),this.injectStyles(),e.autoShow&&this.show()}injectStyles(){const e="alra-summary-modal-styles";if(document.getElementById(e))return;const n=document.createElement("style");n.id=e,n.textContent="\n      @keyframes alraFadeIn {\n        from {\n          opacity: 0;\n          transform: translateY(-20px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      @keyframes alraSlideIn {\n        from {\n          transform: translateX(400px);\n          opacity: 0;\n        }\n        to {\n          transform: translateX(0);\n          opacity: 1;\n        }\n      }\n\n      .alra-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.3);\n        backdrop-filter: blur(4px);\n        z-index: 999998;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        animation: alraFadeIn 0.3s ease-out;\n      }\n\n      .alra-summary-modal {\n        position: fixed;\n        max-width: 500px;\n        width: 90%;\n        max-height: 80vh;\n        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);\n        backdrop-filter: blur(20px) saturate(180%);\n        border: 1px solid rgba(255, 255, 255, 0.3);\n        border-radius: 16px;\n        box-shadow: \n          0 20px 60px rgba(0, 0, 0, 0.15),\n          0 0 0 1px rgba(255, 255, 255, 0.1) inset;\n        z-index: 999999;\n        overflow: hidden;\n        animation: alraFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n      }\n\n      .alra-summary-modal.top-right {\n        top: 80px;\n        right: 20px;\n        animation: alraSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .alra-summary-modal.center {\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n      }\n\n      .alra-modal-header {\n        padding: 24px 28px;\n        background: #FFFFFF;\n        border-bottom: 1px solid rgba(0, 0, 0, 0.06);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .alra-modal-title {\n        font-size: 20px;\n        font-weight: 700;\n        color: #1F2937;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        letter-spacing: -0.01em;\n      }\n\n      .alra-modal-close {\n        background: rgba(0, 0, 0, 0.04);\n        border: none;\n        color: #6B7280;\n        width: 32px;\n        height: 32px;\n        border-radius: 8px;\n        cursor: pointer;\n        font-size: 22px;\n        line-height: 1;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .alra-modal-close:hover {\n        background: rgba(0, 0, 0, 0.08);\n        color: #1F2937;\n        transform: scale(1.05);\n      }\n\n      .alra-modal-stats {\n        padding: 20px 28px;\n        background: rgba(249, 250, 251, 0.5);\n        display: flex;\n        gap: 32px;\n        flex-wrap: wrap;\n        border-bottom: 1px solid rgba(0, 0, 0, 0.06);\n      }\n\n      .alra-stat {\n        display: flex;\n        flex-direction: column;\n        gap: 6px;\n      }\n\n      .alra-stat-label {\n        font-size: 12px;\n        text-transform: uppercase;\n        letter-spacing: 0.05em;\n        color: #6B7280;\n        font-weight: 500;\n      }\n\n      .alra-stat-value {\n        font-size: 24px;\n        font-weight: 700;\n        color: #2563EB;\n        letter-spacing: -0.02em;\n      }\n\n      .alra-modal-content {\n        padding: 24px;\n        max-height: 50vh;\n        overflow-y: auto;\n      }\n\n      .alra-modal-content::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .alra-modal-content::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.05);\n        border-radius: 4px;\n      }\n\n      .alra-modal-content::-webkit-scrollbar-thumb {\n        background: linear-gradient(135deg, #667eea, #764ba2);\n        border-radius: 4px;\n      }\n\n      .alra-summary-text {\n        font-size: 15px;\n        line-height: 1.8;\n        color: #374151;\n        margin-bottom: 24px;\n      }\n\n      .alra-key-points {\n        background: rgba(249, 250, 251, 0.8);\n        border-left: 3px solid #2563EB;\n        border-radius: 12px;\n        padding: 20px;\n        margin-bottom: 24px;\n      }\n\n      .alra-key-points-title {\n        font-size: 13px;\n        font-weight: 700;\n        color: #1F2937;\n        text-transform: uppercase;\n        letter-spacing: 0.05em;\n        margin-bottom: 14px;\n      }\n\n      .alra-key-point {\n        font-size: 14px;\n        line-height: 1.7;\n        color: #4B5563;\n        padding: 10px 0;\n        padding-left: 24px;\n        position: relative;\n      }\n\n      .alra-key-point::before {\n        content: \"â€¢\";\n        position: absolute;\n        left: 8px;\n        color: #2563EB;\n        font-weight: bold;\n        font-size: 18px;\n      }\n\n      .alra-keywords {\n        display: flex;\n        gap: 8px;\n        flex-wrap: wrap;\n      }\n\n      .alra-keyword-tag {\n        background: rgba(37, 99, 235, 0.08);\n        color: #2563EB;\n        padding: 8px 14px;\n        border-radius: 8px;\n        font-size: 12px;\n        font-weight: 600;\n        border: 1px solid rgba(37, 99, 235, 0.12);\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .alra-keyword-tag:hover {\n        background: rgba(37, 99, 235, 0.12);\n        transform: translateY(-1px);\n      }\n\n      .alra-modal-footer {\n        padding: 16px 24px;\n        background: rgba(247, 250, 252, 0.8);\n        border-top: 1px solid rgba(0, 0, 0, 0.08);\n        display: flex;\n        gap: 12px;\n      }\n\n      .alra-btn {\n        flex: 1;\n        padding: 10px 16px;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        border: none;\n      }\n\n      .alra-btn-primary {\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n      }\n\n      .alra-btn-primary:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n      }\n\n      .alra-btn-secondary {\n        background: white;\n        color: #667eea;\n        border: 2px solid #667eea;\n      }\n\n      .alra-btn-secondary:hover {\n        background: rgba(102, 126, 234, 0.05);\n      }\n    ",document.head.appendChild(n)}createModal(){const{summary:e,position:n="top-right"}=this.config;this.overlay=document.createElement("div"),this.overlay.className="alra-modal-overlay",this.overlay.style.display="none",this.overlay.onclick=e=>{e.target===this.overlay&&this.hide()},this.modal=document.createElement("div"),this.modal.className=`alra-summary-modal ${n}`,this.modal.style.display="none";const t=document.createElement("div");t.className="alra-modal-header",t.innerHTML='\n      <div class="alra-modal-title">\n        <span>âœ¨</span>\n        <span>AI Summary</span>\n      </div>\n    ';const o=document.createElement("button");o.className="alra-modal-close",o.innerHTML="Ã—",o.setAttribute("type","button"),o.setAttribute("aria-label","Close modal"),o.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.hide()}),o.onclick=e=>{e?.preventDefault(),e?.stopPropagation(),this.hide()},t.appendChild(o);const a=document.createElement("div");a.className="alra-modal-stats";const i=Math.round(100*(1-e.compressionRatio)),s=e.readingTime.original-e.readingTime.summary;a.innerHTML=`\n      <div class="alra-stat">\n        <div class="alra-stat-label">Compression</div>\n        <div class="alra-stat-value">${i}%</div>\n      </div>\n      <div class="alra-stat">\n        <div class="alra-stat-label">Time Saved</div>\n        <div class="alra-stat-value">${s}m</div>\n      </div>\n      <div class="alra-stat">\n        <div class="alra-stat-label">Confidence</div>\n        <div class="alra-stat-value">${Math.round(100*e.confidence)}%</div>\n      </div>\n    `;const r=document.createElement("div");r.className="alra-modal-content";const l=document.createElement("div");if(l.className="alra-summary-text",l.textContent=e.summaryText,e.keyPoints&&e.keyPoints.length>0){const n=document.createElement("div");n.className="alra-key-points",n.innerHTML=`\n        <div class="alra-key-points-title">Key Points</div>\n        ${e.keyPoints.map(e=>`\n          <div class="alra-key-point">${e}</div>\n        `).join("")}\n      `,r.appendChild(n)}if(r.appendChild(l),e.keywords&&e.keywords.length>0){const n=document.createElement("div");n.className="alra-keywords",e.keywords.forEach(e=>{const t=document.createElement("span");t.className="alra-keyword-tag",t.textContent=e,n.appendChild(t)}),r.appendChild(n)}const d=document.createElement("div");d.className="alra-modal-footer",d.innerHTML='\n      <button class="alra-btn alra-btn-primary" id="alra-read-full">Read Full Article</button>\n      <button class="alra-btn alra-btn-secondary" id="alra-share-summary">Share Summary</button>\n    ',this.modal.appendChild(t),this.modal.appendChild(a),this.modal.appendChild(r),this.modal.appendChild(d),d.querySelector("#alra-read-full")?.addEventListener("click",()=>{this.hide(),window.scrollTo({top:0,behavior:"smooth"})}),d.querySelector("#alra-share-summary")?.addEventListener("click",()=>{this.shareSummary()}),"center"===n?(this.overlay.appendChild(this.modal),document.body.appendChild(this.overlay)):document.body.appendChild(this.modal)}show(){this.isVisible||("center"===this.config.position&&this.overlay&&(this.overlay.style.display="flex"),this.modal&&(this.modal.style.display="block",this.modal.offsetHeight),this.isVisible=!0,console.log("âœ¨ ALRA: Summary modal shown"))}hide(){this.isVisible&&(this.overlay&&(this.overlay.style.display="none"),this.modal&&(this.modal.style.display="none"),this.isVisible=!1,console.log("ğŸ‘‹ ALRA: Summary modal hidden"))}toggle(){this.isVisible?this.hide():this.show()}destroy(){this.overlay&&this.overlay.remove(),this.modal&&this.modal.remove(),this.isVisible=!1}async shareSummary(){const e=`ğŸ“ Summary: ${this.config.summary.summaryText}\n\nGenerated by ALRA AI Browser Assistant`;if(navigator.share)try{await navigator.share({title:"Article Summary",text:e}),console.log("âœ… ALRA: Summary shared")}catch(n){this.copyToClipboard(e)}else this.copyToClipboard(e)}copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>{this.showToast("âœ… Summary copied to clipboard!")}).catch(()=>{console.log("âš ï¸ ALRA: Could not copy summary")})}showToast(e){const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 12px 20px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n      z-index: 10000000;\n      animation: alraFadeIn 0.3s ease-out;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n    ",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="all 0.3s ease-out",setTimeout(()=>n.remove(),300)},2e3)}}const n=new class{constructor(){this.metrics={timeSavedSeconds:0,articlesSummarized:0,tabsPredicted:0,clicksReduced:0}}async trackEvent(e){switch(e.type){case"time_saved":this.metrics.timeSavedSeconds+=e.value;break;case"article_summarized":this.metrics.articlesSummarized+=1;break;case"tab_predicted":this.metrics.tabsPredicted+=1;break;case"click_reduced":this.metrics.clicksReduced+=1}try{chrome.runtime.id,await chrome.storage.local.set({alraMetrics:this.metrics})}catch(e){e instanceof Error&&!e.message.includes("Extension context invalidated")&&console.debug("Could not save metrics:",e.message)}}async getMetrics(){try{chrome.runtime.id;const e=await chrome.storage.local.get("alraMetrics");e.alraMetrics&&(this.metrics=e.alraMetrics)}catch(e){e instanceof Error&&!e.message.includes("Extension context invalidated")&&console.debug("Could not load metrics:",e.message)}return{...this.metrics}}};function t(){console.log(" ALRA: Metrics tracking initialized")}function o(e){const n=[],t=e.match(/([^.!?]*[.!?]+)/g)||[],o=Math.max(1,t.length);return t.forEach((e,t)=>{const a=e.trim();if(a.length>10){const e=a.split(/\s+/).filter(e=>e.length>0),i=new Set(e.map(e=>e.toLowerCase()));n.push({text:a,wordCount:e.length,wordSet:i,position:t/o,score:0})}}),n}function a(e,n=5){const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","is","are","was","were"]),o=e.toLowerCase().match(/\b\w+\b/g)||[],a=new Map;return o.forEach(e=>{!t.has(e)&&e.length>3&&a.set(e,(a.get(e)||0)+1)}),Array.from(a.entries()).sort((e,n)=>n[1]-e[1]).slice(0,n).map(([e])=>e)}function i(e){console.log(`ğŸ“„ ALRA: Generating summary for block ${e.id}...`);const n=new Map,t=new Set(["the","a","an","and","or","but","in","on","at","to","for","is","are"]);e.sentences.forEach(e=>{e.wordSet.forEach(e=>{!t.has(e)&&e.length>2&&n.set(e,(n.get(e)||0)+1)})}),e.sentences.forEach(e=>{let t=0;e.wordSet.forEach(e=>{t+=n.get(e)||0}),t/=Math.max(1,e.wordCount);const o=1+.3*(1-e.position);t*=o,e.wordCount<5?t*=.5:e.wordCount>30&&(t*=.7),e.score=t});const o=e.sentences.map((e,n)=>({...e,originalIndex:n})).sort((e,n)=>n.score-e.score).slice(0,Math.max(2,Math.ceil(.4*e.sentences.length))).sort((e,n)=>e.originalIndex-n.originalIndex),i=o.map(e=>e.text).join(" "),s=o.slice(0,3).map(e=>e.text),r=a(e.rawText,5),l=i.length/e.rawText.length,d=Math.max(1,Math.ceil(i.split(/\s+/).length/200));return{id:`summary-${e.id}`,originalText:e.rawText,summaryText:i,keyPoints:s,keywords:r,compressionRatio:Math.min(l,.9),readingTime:{original:e.estimatedReadingTime,summary:d},importance:e.importance,method:"extractive",confidence:Math.min(.95,.7+o.length/e.sentences.length*.25),sourceElement:e.element}}async function s(e){try{const n=`req-${Date.now()}-${Math.random()}`,t=await new Promise((t,o)=>{const a=e=>{e.detail.requestId===n&&(window.removeEventListener("ALRA_AI_RESPONSE",a),e.detail.success?t(e.detail.result):o(new Error(e.detail.error||"AI operation failed")))};window.addEventListener("ALRA_AI_RESPONSE",a),window.dispatchEvent(new CustomEvent("ALRA_AI_REQUEST",{detail:{action:"SUMMARIZE",data:{text:e.rawText.substring(0,4e3),type:"key-points",format:"markdown",length:"medium"},requestId:n}})),setTimeout(()=>{window.removeEventListener("ALRA_AI_RESPONSE",a),o(new Error("AI operation timeout"))},1e4)});if(t){const n=t,o=n.split("\n").filter(e=>e.trim().length>0).slice(0,3),i=n.length/e.rawText.length;return console.log("âœ… ALRA: Used Chrome Summarizer API via injected bridge"),console.log("   Chrome API: Yes"),console.log(`   Words: ${e.wordCount} â†’ ${n.split(/\s+/).length} (${Math.round(100*i)}% compression)`),{id:`summary-${e.id}`,originalText:e.rawText,summaryText:n,keyPoints:o,keywords:a(e.rawText,5),compressionRatio:Math.min(i,.9),readingTime:{original:e.estimatedReadingTime,summary:Math.max(1,Math.ceil(n.split(/\s+/).length/200))},importance:e.importance,method:"chrome-api",confidence:.98,sourceElement:e.element}}return console.debug("âš ï¸ ALRA: Chrome API returned empty, using extractive fallback"),i(e)}catch(n){return console.debug("âš ï¸ ALRA: Chrome API failed, using extractive",n),i(e)}}let r=0,l=0,d=!1;function c(e){const n=document.createElement("div");n.style.cssText="\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: white;\n    padding: 12px 20px;\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n    z-index: 10000000;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n    animation: slideIn 0.3s ease-out;\n  ",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="all 0.3s ease-out",setTimeout(()=>n.remove(),300)},3e3)}function m(){navigator.clipboard.writeText(window.location.href).then(()=>{c("âœ… Link copied to clipboard!")})}const p=new Set,u=new Set;let h=0,g={nudgesGenerated:0,nudgesShown:0,nudgesActedUpon:0,nudgesDismissed:0,avgTimeToAction:0,conversionRate:0};function b(e,n){"acted"===n?g.nudgesActedUpon++:g.nudgesDismissed++,g.conversionRate=g.nudgesShown>0?g.nudgesActedUpon/g.nudgesShown*100:0,console.log(`ğŸ“Š ALRA: Nudge ${n}: ${e}`)}async function y(e,n){if(p.has(e.id))return;if(u.has(e.trigger))return;const t=n.maxNudgesPerPage||3;if(h>=t)return;const o=function(e){const n=document.createElement("div");n.className=`alra-nudge alra-nudge-${e.priority}`,n.id=e.id,n.setAttribute("data-nudge-trigger",e.trigger),n.style.cssText="\n    position: fixed;\n    bottom: 24px;\n    right: 24px;\n    background: rgba(255, 255, 255, 0.98);\n    backdrop-filter: blur(10px);\n    border-radius: 12px;\n    padding: 18px 20px;\n    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.04);\n    display: flex;\n    align-items: center;\n    gap: 14px;\n    z-index: 10000;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n    max-width: 340px;\n    border: 1px solid rgba(0, 0, 0, 0.06);\n  ";let t="#2563EB";"high"===e.priority&&(t="#EF4444"),"optional"===e.priority&&(t="#10B981"),n.style.borderLeft=`3px solid ${t}`;const o=document.createElement("div");o.style.cssText="font-size: 24px; flex-shrink: 0;",o.textContent=e.emoji;const a=document.createElement("div");a.style.cssText="flex: 1;";const i=document.createElement("div");i.style.cssText="font-size: 14px; font-weight: 500; color: #1F2937; line-height: 1.5; margin-bottom: 4px;",i.textContent=e.text,a.appendChild(i);const s=document.createElement("button");s.style.cssText=`\n    background: ${t};\n    color: white;\n    border: none;\n    border-radius: 8px;\n    padding: 8px 16px;\n    font-size: 13px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n  `,s.textContent=e.actionText,s.onmouseover=()=>{s.style.transform="translateY(-1px)",s.style.boxShadow=`0 4px 12px ${t}40`},s.onmouseout=()=>{s.style.transform="translateY(0)",s.style.boxShadow="none"},s.onclick=()=>{e.action&&e.action(),b(e.id,"acted"),h--,n.remove()};const r=document.createElement("button");r.style.cssText="\n    background: rgba(0, 0, 0, 0.04);\n    border: none;\n    color: #9CA3AF;\n    cursor: pointer;\n    font-size: 18px;\n    padding: 0;\n    margin-left: 8px;\n    width: 28px;\n    height: 28px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex-shrink: 0;\n    border-radius: 6px;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n  ",r.textContent="Ã—",r.title="Dismiss",r.onmouseover=()=>{r.style.background="rgba(0, 0, 0, 0.08)",r.style.color="#374151"},r.onmouseout=()=>{r.style.background="rgba(0, 0, 0, 0.04)",r.style.color="#9CA3AF"},r.onclick=()=>{b(e.id,"dismissed"),u.add(e.trigger),h--,n.remove()},n.appendChild(o),n.appendChild(a),n.appendChild(s),n.appendChild(r);const l=document.createElement("style");return l.textContent="\n    @keyframes slideIn {\n      from {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n  ",document.head.appendChild(l),n}(e);document.body.appendChild(o),p.add(e.id),h++,g.nudgesShown++,console.log(`ğŸ’¡ ALRA: Showing nudge: "${e.text}" (${e.priority})`),n.autoHideAfter&&setTimeout(()=>{document.body.contains(o)&&(h--,o.remove())},1e3*n.autoHideAfter)}async function x(e,t,o){return console.log("ğŸ’¡ ALRA: Initializing Phase 5 - Contextual Nudges"),e.enabled?(setInterval(()=>{r++},1e3),window.addEventListener("scroll",()=>{l=function(){const e=window.innerHeight,n=document.documentElement.scrollHeight,t=window.scrollY;return Math.min(100,Math.round((t+e)/n*100))}()}),window.addEventListener("click",()=>{d=!0}),setInterval(async()=>{if(!function(e,n){const t=e.minTimeOnPage||30;return!(r<t)&&("article"===n&&l>50||"documentation"===n&&l>30||!("product"!==n||!d))}(e,t))return;const a=e.maxNudgesPerPage||3;if(p.size>=a)return;const i=function(e,t,o){const a=[],i=`nudge-${Date.now()}`;return t.includes("wikipedia.org")&&(o>60&&a.push({id:`${i}-1`,text:"Explore related topics",emoji:"ğŸ”—",priority:"suggested",actionText:"See Also",trigger:"deep_scroll_wikipedia",timestamp:Date.now(),action:()=>{const e=Array.from(document.querySelectorAll("h2, h3")).find(e=>e.textContent?.toLowerCase().includes("see also"));e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),console.log('âœ… ALRA: Scrolled to "See also" section'))}}),o>40&&a.push({id:`${i}-2`,text:"Save this article for later",emoji:"ğŸ“Œ",priority:"optional",actionText:"Bookmark",trigger:"mid_scroll_wikipedia",timestamp:Date.now(),action:async()=>{try{chrome.bookmarks&&(await chrome.bookmarks.create({title:document.title,url:window.location.href}),c("âœ… Bookmarked successfully!"),console.log("âœ… ALRA: Page bookmarked"))}catch(e){window.open(`javascript:(function(){window.external.AddFavorite('${window.location.href}','${document.title}');})();`)}}})),t.includes("github.com")&&a.push({id:`${i}-3`,text:"Star this repository",emoji:"â­",priority:"suggested",actionText:"Star",trigger:"github_repo",timestamp:Date.now(),action:()=>{const e=document.querySelector('button[data-test-id="star-button"], button[aria-label*="Star"]');e?(e.click(),c("â­ Starred repository!"),console.log("âœ… ALRA: Starred GitHub repository")):c("âš ï¸ Could not find star button")}}),("documentation"===e||t.includes("docs.")||t.includes("/docs/"))&&o>50&&a.push({id:`${i}-4`,text:"Copy code example",emoji:"ğŸ’»",priority:"high",actionText:"Copy Code",trigger:"docs_engagement",timestamp:Date.now(),action:async()=>{const e=document.querySelector("pre code, .highlight code, code");if(e){const t=e.textContent||"";await navigator.clipboard.writeText(t),c("âœ… Code copied to clipboard!"),console.log("âœ… ALRA: Copied code example"),await n.trackEvent({type:"click_reduced",value:3,timestamp:Date.now()})}}}),"article"===e&&(o>70&&a.push({id:`${i}-5`,text:"Share this article",emoji:"ğŸ“¤",priority:"optional",actionText:"Share",trigger:"article_completion",timestamp:Date.now(),action:async()=>{if(navigator.share)try{await navigator.share({title:document.title,text:"Check out this article!",url:window.location.href}),console.log("âœ… ALRA: Article shared")}catch(e){m()}else m()}}),r>120&&a.push({id:`${i}-6`,text:"Take a 20-second break",emoji:"ğŸ§˜",priority:"suggested",actionText:"Start Timer",trigger:"long_reading_session",timestamp:Date.now(),action:()=>{let e=20;const n=function(e){const n=document.createElement("div");return n.style.cssText="\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: linear-gradient(135deg, rgba(26, 32, 44, 0.95) 0%, rgba(45, 55, 72, 0.95) 100%);\n    backdrop-filter: blur(20px);\n    color: white;\n    padding: 40px 60px;\n    border-radius: 16px;\n    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    z-index: 10000001;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    text-align: center;\n  ",n.innerHTML=`\n    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ§˜</div>\n    <div style="font-size: 64px; font-weight: 700; margin-bottom: 8px;" id="alra-timer-countdown">${e}</div>\n    <div style="font-size: 16px; color: #cbd5e0;">Take a deep breath...</div>\n  `,document.body.appendChild(n),n}(e),t=setInterval(()=>{e--,e<=0?(clearInterval(t),c("âœ… Break complete! Back to reading ğŸ“–")):function(e,n){const t=e.querySelector("#alra-timer-countdown");t&&(t.textContent=n.toString()),n<=0&&e.remove()}(n,e)},1e3);console.log("âœ… ALRA: Started 20-second break timer")}})),r>300&&a.push({id:`${i}-7`,text:"Copy page summary",emoji:"ğŸ“",priority:"high",actionText:"Copy Summary",trigger:"extended_session",timestamp:Date.now(),action:async()=>{const e=`ğŸ“ Summary of "${document.title}"\n\nRead on: ${window.location.href}\n\nYou spent ${Math.floor(r/60)} minutes on this page.`;await navigator.clipboard.writeText(e),c("âœ… Summary copied to clipboard!"),console.log("âœ… ALRA: Copied page summary")}}),a}(t,o,l);if(g.nudgesGenerated+=i.length,i.length>0){const n=await async function(e){try{if(!("ai"in window)||!("writer"in window.ai))return null;const n=await window.ai.writer.create({tone:"casual",length:"short"}),t=`Based on this content: "${e.substring(0,300)}"\nSuggest ONE specific, actionable next step (max 8 words).\nFormat: [action only, no emoji]\nExamples: "Read related article", "Save for later", "Share with team"`;return await n.write(t)}catch(e){return console.debug("âš ï¸ ALRA: Writer API unavailable, using fallback"),null}}(document.title+" "+document.body.innerText.substring(0,500));if(n){const t={id:`nudge-ai-${Date.now()}`,text:n,emoji:"âœ¨",priority:"suggested",actionText:"Try It",trigger:"writer_api",timestamp:Date.now()};await y(t,e)}else{const n=i.slice(0,a-p.size);for(const t of n)u.has(t.trigger)||(await y(t,e),await new Promise(e=>setTimeout(e,2e3)))}}},15e3),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("âœ… ALRA: Phase 5 - Contextual Nudges Active"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ğŸ’¡ Nudge system ready"),console.log(`   Min time on page: ${e.minTimeOnPage||30}s`),console.log(`   Max nudges per page: ${e.maxNudgesPerPage||3}`),console.log(`   Auto-hide after: ${e.autoHideAfter||10}s`),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),g):(console.log("â­ï¸ ALRA: Nudges disabled"),g)}class f{constructor(e){this.container=null,this.mainButton=null,this.menuItems=[],this.isOpen=!1,this.options=[],this.options=e,this.createMenu(),this.injectStyles()}injectStyles(){const e="alra-floating-menu-styles";if(document.getElementById(e))return;const n=document.createElement("style");n.id=e,n.textContent="\n      @keyframes alra-fab-pop {\n        0% { transform: scale(0); opacity: 0; }\n        50% { transform: scale(1.1); }\n        100% { transform: scale(1); opacity: 1; }\n      }\n\n      @keyframes alra-fab-slide-in {\n        from {\n          transform: translateY(20px) scale(0.8);\n          opacity: 0;\n        }\n        to {\n          transform: translateY(0) scale(1);\n          opacity: 1;\n        }\n      }\n\n      .alra-floating-container {\n        position: fixed;\n        bottom: 24px;\n        right: 24px;\n        z-index: 999999;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      }\n\n      .alra-fab-main {\n        width: 64px;\n        height: 64px;\n        border-radius: 50%;\n        background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%);\n        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        border: none;\n        position: relative;\n        animation: alra-fab-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .alra-fab-main:hover {\n        transform: scale(1.05);\n        box-shadow: 0 12px 32px rgba(37, 99, 235, 0.5);\n      }\n\n      .alra-fab-main.open {\n        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);\n        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);\n      }\n\n      .alra-fab-icon {\n        font-size: 28px;\n        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .alra-fab-main.open .alra-fab-icon {\n        transform: rotate(45deg);\n      }\n\n      .alra-fab-menu {\n        position: absolute;\n        bottom: 80px;\n        right: 0;\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n      }\n\n      .alra-fab-menu.open {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .alra-fab-menu-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        background: rgba(255, 255, 255, 0.98);\n        backdrop-filter: blur(10px);\n        padding: 12px 20px;\n        border-radius: 50px;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);\n        cursor: pointer;\n        border: 1px solid rgba(0, 0, 0, 0.06);\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        min-width: 200px;\n        transform-origin: right center;\n        animation: alra-fab-slide-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        position: relative;\n      }\n\n      .alra-fab-menu-item:nth-child(1) { animation-delay: 0.05s; }\n      .alra-fab-menu-item:nth-child(2) { animation-delay: 0.1s; }\n      .alra-fab-menu-item:nth-child(3) { animation-delay: 0.15s; }\n      .alra-fab-menu-item:nth-child(4) { animation-delay: 0.2s; }\n      .alra-fab-menu-item:nth-child(5) { animation-delay: 0.25s; }\n      .alra-fab-menu-item:nth-child(6) { animation-delay: 0.3s; }\n      .alra-fab-menu-item:nth-child(7) { animation-delay: 0.35s; }\n\n      .alra-fab-menu-item:hover {\n        transform: translateX(-4px) scale(1.02);\n        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.2);\n        background: rgba(37, 99, 235, 0.04);\n      }\n\n      .alra-fab-menu-icon {\n        font-size: 24px;\n        width: 40px;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);\n        border-radius: 50%;\n        flex-shrink: 0;\n      }\n\n      .alra-fab-menu-label {\n        font-size: 14px;\n        font-weight: 600;\n        color: #1F2937;\n        white-space: nowrap;\n      }\n\n      .alra-fab-badge {\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        background: #EF4444;\n        color: white;\n        border-radius: 12px;\n        padding: 2px 6px;\n        font-size: 10px;\n        font-weight: 700;\n        min-width: 18px;\n        text-align: center;\n        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);\n        border: 2px solid white;\n      }\n    ",document.head.appendChild(n)}createMenu(){this.container=document.createElement("div"),this.container.className="alra-floating-container",this.mainButton=document.createElement("button"),this.mainButton.className="alra-fab-main",this.mainButton.innerHTML='<div class="alra-fab-icon">âœ¨</div>',this.mainButton.onclick=()=>this.toggle();const e=document.createElement("div");e.className="alra-fab-menu",this.options.forEach(n=>{const t=document.createElement("div");t.className="alra-fab-menu-item",t.innerHTML=`\n        <div class="alra-fab-menu-icon">${n.icon}</div>\n        <div class="alra-fab-menu-label">${n.label}</div>\n        ${n.badge?`<div class="alra-fab-badge">${n.badge}</div>`:""}\n      `,t.onclick=()=>{n.action(),this.close()},this.menuItems.push(t),e.appendChild(t)}),this.container.appendChild(e),this.container.appendChild(this.mainButton),document.body.appendChild(this.container)}toggle(){this.isOpen?this.close():this.open()}open(){if(!this.container||!this.mainButton)return;this.isOpen=!0,this.mainButton.classList.add("open");const e=this.container.querySelector(".alra-fab-menu");e&&e.classList.add("open")}close(){if(!this.container||!this.mainButton)return;this.isOpen=!1,this.mainButton.classList.remove("open");const e=this.container.querySelector(".alra-fab-menu");e&&e.classList.remove("open")}updateBadge(e,n){const t=this.options.findIndex(n=>n.id===e);if(-1!==t&&this.menuItems[t]){const e=this.menuItems[t].querySelector(".alra-fab-badge");if(n>0)if(e)e.textContent=n.toString();else{const e=document.createElement("div");e.className="alra-fab-badge",e.textContent=n.toString(),this.menuItems[t].appendChild(e)}else e?.remove()}}remove(){this.container?.remove(),document.getElementById("alra-floating-menu-styles")?.remove()}}class v{constructor(){this.modal=null,this.overlay=null,this.isVisible=!1,this.createModal(),this.injectStyles()}injectStyles(){const e="alra-metrics-modal-styles";if(document.getElementById(e))return;const n=document.createElement("style");n.id=e,n.textContent="\n      .alra-metrics-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.3);\n        backdrop-filter: blur(4px);\n        z-index: 999998;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .alra-metrics-modal {\n        position: relative;\n        width: 90%;\n        max-width: 500px;\n        background: white;\n        border-radius: 16px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);\n        overflow: hidden;\n      }\n\n      .alra-metrics-header {\n        padding: 24px 28px;\n        background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%);\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .alra-metrics-title {\n        font-size: 20px;\n        font-weight: 700;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n      }\n\n      .alra-metrics-close {\n        background: rgba(255, 255, 255, 0.2);\n        border: none;\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 8px;\n        cursor: pointer;\n        font-size: 22px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n      }\n\n      .alra-metrics-close:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .alra-metrics-content {\n        padding: 28px;\n      }\n\n      .alra-metrics-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 16px;\n        margin-bottom: 20px;\n      }\n\n      .alra-metric-card {\n        background: linear-gradient(135deg, #F9FAFB 0%, #FFFFFF 100%);\n        border: 1px solid #E5E7EB;\n        border-radius: 12px;\n        padding: 20px;\n        text-align: center;\n      }\n\n      .alra-metric-icon {\n        font-size: 32px;\n        margin-bottom: 8px;\n      }\n\n      .alra-metric-value {\n        font-size: 28px;\n        font-weight: 700;\n        color: #2563EB;\n        margin-bottom: 4px;\n      }\n\n      .alra-metric-label {\n        font-size: 12px;\n        color: #6B7280;\n        text-transform: uppercase;\n        letter-spacing: 0.05em;\n        font-weight: 600;\n      }\n    ",document.head.appendChild(n)}createModal(){this.overlay=document.createElement("div"),this.overlay.className="alra-metrics-overlay",this.overlay.style.display="none",this.overlay.onclick=e=>{e.target===this.overlay&&this.hide()},this.modal=document.createElement("div"),this.modal.className="alra-metrics-modal",this.overlay.appendChild(this.modal),document.body.appendChild(this.overlay)}async show(e){if(!this.modal)return;const n=Math.floor(e.timeSavedSeconds/60),t=Math.floor(n/60),o=t>0?`${t}h ${n%60}m`:`${n}m`;this.modal.innerHTML=`\n      <div class="alra-metrics-header">\n        <div class="alra-metrics-title">\n          <span>ğŸ“Š</span>\n          <span>Your Productivity</span>\n        </div>\n        <button class="alra-metrics-close">Ã—</button>\n      </div>\n      <div class="alra-metrics-content">\n        <div class="alra-metrics-grid">\n          <div class="alra-metric-card">\n            <div class="alra-metric-icon">â±ï¸</div>\n            <div class="alra-metric-value">${o}</div>\n            <div class="alra-metric-label">Time Saved</div>\n          </div>\n          <div class="alra-metric-card">\n            <div class="alra-metric-icon">ğŸ“–</div>\n            <div class="alra-metric-value">${e.articlesSummarized}</div>\n            <div class="alra-metric-label">Articles</div>\n          </div>\n          <div class="alra-metric-card">\n            <div class="alra-metric-icon">ğŸ¯</div>\n            <div class="alra-metric-value">${e.tabsPredicted}</div>\n            <div class="alra-metric-label">Tabs Predicted</div>\n          </div>\n          <div class="alra-metric-card">\n            <div class="alra-metric-icon">ğŸ–±ï¸</div>\n            <div class="alra-metric-value">${e.clicksReduced}</div>\n            <div class="alra-metric-label">Clicks Reduced</div>\n          </div>\n        </div>\n      </div>\n    `;const a=this.modal.querySelector(".alra-metrics-close");a&&a.addEventListener("click",()=>this.hide()),this.overlay&&(this.overlay.style.display="flex"),this.isVisible=!0}hide(){this.isVisible&&(this.overlay&&(this.overlay.style.display="none"),this.isVisible=!1)}}class w{constructor(){this.overlay=null,this.panel=null,this.isGenerating=!1,this.createPanel()}createPanel(){this.overlay=document.createElement("div"),this.overlay.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.5);\n      backdrop-filter: blur(4px);\n      z-index: 2147483646;\n      display: none;\n      animation: fadeIn 0.2s ease-out;\n    ",this.panel=document.createElement("div"),this.panel.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      width: 90%;\n      max-width: 500px;\n      max-height: 80vh;\n      overflow: hidden;\n      z-index: 2147483647;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    ";const e=document.createElement("div");e.style.cssText="\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 20px 24px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n    ";const n=document.createElement("div");n.innerHTML='\n      <div style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">ğŸ’¡ Smart Suggestions</div>\n      <div style="font-size: 13px; opacity: 0.9;">AI-powered recommendations based on this page</div>\n    ';const t=document.createElement("button");t.textContent="Ã—",t.style.cssText="\n      background: rgba(255, 255, 255, 0.2);\n      border: none;\n      color: white;\n      font-size: 28px;\n      width: 32px;\n      height: 32px;\n      border-radius: 8px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.2s;\n      padding: 0;\n      line-height: 1;\n    ",t.onmouseover=()=>t.style.background="rgba(255, 255, 255, 0.3)",t.onmouseout=()=>t.style.background="rgba(255, 255, 255, 0.2)",t.onclick=()=>this.hide(),e.appendChild(n),e.appendChild(t);const o=document.createElement("div");o.id="alra-nudges-content",o.style.cssText="\n      padding: 24px;\n      max-height: calc(80vh - 100px);\n      overflow-y: auto;\n    ",this.panel.appendChild(e),this.panel.appendChild(o),this.overlay.onclick=()=>this.hide();const a=document.createElement("style");a.textContent="\n      @keyframes fadeIn {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n      @keyframes slideUp {\n        from {\n          opacity: 0;\n          transform: translate(-50%, -45%);\n        }\n        to {\n          opacity: 1;\n          transform: translate(-50%, -50%);\n        }\n      }\n    ",document.head.appendChild(a)}async show(){this.overlay&&this.panel&&(document.body.contains(this.overlay)||document.body.appendChild(this.overlay),document.body.contains(this.panel)||document.body.appendChild(this.panel),this.overlay.style.display="block",this.panel.style.display="block",await this.generateSmartSuggestions())}hide(){this.overlay&&this.panel&&(this.overlay.style.display="none",this.panel.style.display="none",document.body.contains(this.overlay)&&this.overlay.remove(),document.body.contains(this.panel)&&this.panel.remove())}async generateSmartSuggestions(){const e=document.getElementById("alra-nudges-content");if(!e||this.isGenerating)return;this.isGenerating=!0,e.innerHTML='\n      <div style="text-align: center; padding: 40px 20px; color: #6B7280;">\n        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¤–</div>\n        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Analyzing this page...</div>\n        <div style="font-size: 14px;">Gemini Nano is generating smart suggestions</div>\n        <div style="margin-top: 20px;">\n          <div style="width: 40px; height: 40px; border: 3px solid #E5E7EB; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>\n        </div>\n      </div>\n    ';const n=document.createElement("style");n.textContent="\n      @keyframes spin {\n        to { transform: rotate(360deg); }\n      }\n    ",document.head.appendChild(n);try{const e=this.getPageContext(),n=await this.generateWithChromeAI(e);n.length>0?this.renderSuggestions(n):this.renderFallbackSuggestions(e)}catch(e){console.error("âŒ ALRA: Error generating suggestions:",e),this.renderError()}finally{this.isGenerating=!1}}getPageContext(){return`Page: ${document.title}\nURL: ${window.location.href}\nContent: ${Array.from(document.querySelectorAll("p, h1, h2, h3")).map(e=>e.textContent?.trim()).filter(e=>e&&e.length>20).slice(0,10).join(" ").substring(0,1e3)}`}async generateWithChromeAI(e){return new Promise(n=>{const t=`nudge-${Date.now()}`,o=e=>{const a=e;if(a.detail.requestId===t)if(window.removeEventListener("ALRA_AI_RESPONSE",o),a.detail.success&&a.detail.result){const e=a.detail.result,t=this.parseAISuggestions(e);n(t)}else n([])};window.addEventListener("ALRA_AI_RESPONSE",o),window.dispatchEvent(new CustomEvent("ALRA_AI_REQUEST",{detail:{action:"WRITE",data:{prompt:`Based on this webpage content, suggest 4 specific, actionable next steps the user could take. Make them practical and relevant to the content.\n\n${e}\n\nFormat each suggestion as:\n[emoji] [short action text (max 6 words)]\n\nExamples:\nğŸ“š Read related research papers\nğŸ’¾ Save this for later reference\nğŸ”— Share with your team\nğŸ“ Take notes on key points`,tone:"casual",length:"short"},requestId:t}})),setTimeout(()=>{window.removeEventListener("ALRA_AI_RESPONSE",o),n([])},8e3)})}parseAISuggestions(e){const n=e.split("\n").filter(e=>e.trim()),t=[];for(let e=0;e<Math.min(n.length,4);e++){const o=n[e].trim(),a=o.match(/^([^\w\s]+)\s+(.+)$/);if(a){const n=a[1].trim(),o=a[2].trim();t.push({id:`ai-nudge-${e}`,text:o,emoji:n,category:this.categorizeNudge(o),actionText:"Do it",confidence:.9})}else o.length>5&&t.push({id:`ai-nudge-${e}`,text:o,emoji:"ğŸ’¡",category:"productivity",actionText:"Do it",confidence:.8})}return t}categorizeNudge(e){const n=e.toLowerCase();return n.includes("read")||n.includes("learn")||n.includes("study")?"learning":n.includes("break")||n.includes("rest")||n.includes("wellness")?"wellness":n.includes("navigate")||n.includes("go to")||n.includes("open")?"navigation":"productivity"}renderSuggestions(e){const n=document.getElementById("alra-nudges-content");if(!n)return;n.innerHTML='\n      <div style="margin-bottom: 20px;">\n        <div style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea20, #764ba220); padding: 8px 16px; border-radius: 20px; font-size: 13px; color: #667eea; font-weight: 600;">\n          <span>ğŸ¤–</span>\n          <span>Generated by Gemini Nano</span>\n        </div>\n      </div>\n    ',e.forEach((e,t)=>{const o=this.createSuggestionCard(e,t);n.appendChild(o)});const t=document.createElement("div");t.style.cssText="\n      margin-top: 24px;\n      padding-top: 20px;\n      border-top: 1px solid #E5E7EB;\n      text-align: center;\n      color: #9CA3AF;\n      font-size: 13px;\n    ",t.textContent="âœ¨ These suggestions are personalized based on your current page",n.appendChild(t)}createSuggestionCard(e,n){const t=document.createElement("div");t.style.cssText=`\n      background: white;\n      border: 1.5px solid #E5E7EB;\n      border-radius: 12px;\n      padding: 16px 18px;\n      margin-bottom: 12px;\n      display: flex;\n      align-items: center;\n      gap: 14px;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      cursor: pointer;\n      animation: slideInCard 0.3s ease-out ${.1*n}s both;\n    `;const o=document.createElement("style");o.textContent="\n      @keyframes slideInCard {\n        from {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n    ",document.head.appendChild(o);const a={productivity:"#667eea",learning:"#10B981",wellness:"#F59E0B",navigation:"#6366F1"}[e.category],i=document.createElement("div");i.style.cssText=`\n      font-size: 28px;\n      flex-shrink: 0;\n      width: 48px;\n      height: 48px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: ${a}15;\n      border-radius: 10px;\n    `,i.textContent=e.emoji;const s=document.createElement("div");s.style.cssText="flex: 1;";const r=document.createElement("div");r.style.cssText="\n      font-size: 15px;\n      font-weight: 600;\n      color: #1F2937;\n      margin-bottom: 4px;\n    ",r.textContent=e.text;const l=document.createElement("div");l.style.cssText=`\n      font-size: 12px;\n      color: ${a};\n      text-transform: capitalize;\n      font-weight: 600;\n    `,l.textContent=e.category,s.appendChild(r),s.appendChild(l);const d=document.createElement("button");return d.style.cssText=`\n      background: ${a};\n      color: white;\n      border: none;\n      border-radius: 8px;\n      padding: 10px 20px;\n      font-size: 14px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s;\n      flex-shrink: 0;\n    `,d.textContent=e.actionText,d.onmouseover=()=>{d.style.transform="translateY(-2px)",d.style.boxShadow=`0 4px 12px ${a}40`},d.onmouseout=()=>{d.style.transform="translateY(0)",d.style.boxShadow="none"},t.onmouseover=()=>{t.style.borderColor=a,t.style.boxShadow=`0 4px 12px ${a}20`,t.style.transform="translateY(-2px)"},t.onmouseout=()=>{t.style.borderColor="#E5E7EB",t.style.boxShadow="none",t.style.transform="translateY(0)"},d.onclick=n=>{n.stopPropagation(),e.action&&e.action(),this.showToast(`âœ… ${e.text}`)},t.appendChild(i),t.appendChild(s),t.appendChild(d),t}renderFallbackSuggestions(e){const n=window.location.href,t=[];n.includes("github.com")?t.push({id:"gh1",emoji:"â­",text:"Star this repository",category:"productivity",actionText:"Star",confidence:.9,action:()=>{const e=document.querySelector('button[data-test-id="star-button"], button[aria-label*="Star"]');e?(e.click(),this.showToast("â­ Repository starred!")):this.showToast("âš ï¸ Please star manually")}},{id:"gh2",emoji:"ğŸ“–",text:"Read the documentation",category:"learning",actionText:"Read",confidence:.8,action:()=>{const e=document.querySelector("#readme");e?(e.scrollIntoView({behavior:"smooth",block:"start"}),this.showToast("ğŸ“– Scrolled to documentation")):this.showToast("ğŸ“– Look for README section")}},{id:"gh3",emoji:"ğŸ’¾",text:"Copy clone URL",category:"productivity",actionText:"Copy",confidence:.7,action:async()=>{try{const e=document.querySelector('button[data-testid="clone-button"]');if(e)e.click(),this.showToast("ğŸ’¾ Clone dialog opened");else{const e=window.location.href.replace("github.com","github.com")+".git";await navigator.clipboard.writeText(e),this.showToast("ğŸ’¾ Clone URL copied!")}}catch(e){this.showToast("âš ï¸ Could not copy URL")}}},{id:"gh4",emoji:"ğŸ””",text:"Watch for updates",category:"productivity",actionText:"Watch",confidence:.8,action:()=>{const e=document.querySelector('button[data-test-id="watch-button"]');e?(e.click(),this.showToast("ğŸ”” Watch menu opened")):this.showToast("ğŸ”” Look for Watch button")}}):n.includes("youtube.com")?t.push({id:"yt1",emoji:"ğŸ’¾",text:"Save to Watch Later",category:"productivity",actionText:"Save",confidence:.9,action:()=>{const e=document.querySelector('button[aria-label*="Save"]');e?(e.click(),this.showToast("ğŸ’¾ Save menu opened")):this.showToast("ğŸ’¾ Look for Save button")}},{id:"yt2",emoji:"ğŸ‘",text:"Like this video",category:"productivity",actionText:"Like",confidence:.8,action:()=>{const e=document.querySelector('button[aria-label*="like this video"]');e&&"true"!==e.getAttribute("aria-pressed")?(e.click(),this.showToast("ğŸ‘ Video liked!")):e?this.showToast("ğŸ‘ Already liked!"):this.showToast("âš ï¸ Like button not found")}},{id:"yt3",emoji:"ğŸ“",text:"Open transcript",category:"learning",actionText:"Transcript",confidence:.7,action:()=>{const e=document.querySelector('button[aria-label="More actions"]');e?(e.click(),setTimeout(()=>{const e=document.querySelector('ytd-menu-service-item-renderer:has-text("transcript")');e&&e.click()},200),this.showToast("ğŸ“ Looking for transcript...")):this.showToast("ğŸ“ Check video description")}},{id:"yt4",emoji:"ğŸ”—",text:"Copy video link",category:"productivity",actionText:"Copy",confidence:.9,action:async()=>{try{await navigator.clipboard.writeText(window.location.href),this.showToast("ğŸ”— Video link copied!")}catch(e){this.showToast("âš ï¸ Could not copy link")}}}):t.push({id:"g1",emoji:"ğŸ“š",text:"Bookmark this page",category:"productivity",actionText:"Bookmark",confidence:.9,action:async()=>{try{await chrome.runtime.sendMessage({action:"ADD_BOOKMARK",url:window.location.href,title:document.title}),this.showToast("ğŸ“š Page bookmarked!")}catch(e){this.showToast("ğŸ“š Press Ctrl+D to bookmark")}}},{id:"g2",emoji:"ğŸ“¤",text:"Copy page link",category:"productivity",actionText:"Copy",confidence:.9,action:async()=>{try{await navigator.clipboard.writeText(window.location.href),this.showToast("ğŸ“¤ Link copied to clipboard!")}catch(e){this.showToast("âš ï¸ Could not copy link")}}},{id:"g3",emoji:"ğŸ“",text:"Get AI summary",category:"learning",actionText:"Summarize",confidence:.8,action:()=>{const e=document.querySelector('[data-alra-action="summary"]');e?(e.click(),this.hide(),this.showToast("ğŸ“ Generating summary...")):this.showToast("ğŸ“ Use FAB menu â†’ AI Summary")}},{id:"g4",emoji:"ğŸ”",text:"Search in this page",category:"navigation",actionText:"Search",confidence:.7,action:()=>{document.execCommand("find"),this.showToast("ğŸ” Press Ctrl+F to search")}}),this.renderSuggestions(t)}renderError(){const e=document.getElementById("alra-nudges-content");e&&(e.innerHTML='\n      <div style="text-align: center; padding: 40px 20px; color: #6B7280;">\n        <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>\n        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Couldn\'t generate suggestions</div>\n        <div style="font-size: 14px;">Chrome\'s AI API may not be available yet</div>\n      </div>\n    ')}showToast(e){const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      bottom: 24px;\n      right: 24px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 14px 20px;\n      border-radius: 10px;\n      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);\n      z-index: 2147483647;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n      animation: slideIn 0.3s ease-out;\n    ",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="all 0.3s ease-out",setTimeout(()=>n.remove(),300)},3e3)}}class A{constructor(){this.syncEnabled=!1,this.recommendedTabs=[],this.deviceType=this.detectDeviceType(),this.initializeSync()}detectDeviceType(){const e=navigator.userAgent.toLowerCase();return window.innerWidth<=768&&!e.includes("chrome")?"mobile":/mobile|android|iphone/.test(e)?/tablet|ipad/.test(e)?"tablet":"mobile":"desktop"}async initializeSync(){const e=await chrome.storage.local.get("syncEnabled");this.syncEnabled=e.syncEnabled||!1,this.syncEnabled&&"desktop"===this.deviceType&&this.setupSyncOnClose(),console.log("ğŸ“± ALRA Device Sync: Initialized (device:",this.deviceType,", enabled:",this.syncEnabled,")")}async enableSync(){this.syncEnabled=!0,await chrome.storage.local.set({syncEnabled:!0}),await this.generateRecommendedTabs(),await this.syncToCloud(),this.showToast("âœ… Cross-device sync enabled! Your tabs will sync to Chrome when you close them."),console.log("â˜ï¸ ALRA: Sync enabled. Tabs will be saved to Chrome Sync for access on all your devices.")}async disableSync(){this.syncEnabled=!1,await chrome.storage.local.set({syncEnabled:!1}),await chrome.storage.sync.remove("alra_session"),this.showToast("âŒ Cross-device sync disabled")}setupSyncOnClose(){document.addEventListener("visibilitychange",()=>{document.hidden&&this.syncToCloud().catch(()=>{})}),window.addEventListener("beforeunload",()=>{this.syncToCloud().catch(()=>{})});const e=setInterval(()=>{try{chrome.runtime.id,this.syncToCloud().catch(()=>{})}catch(n){clearInterval(e)}},12e4)}async addRecommendedTab(e,n,t,o){const a={url:e,title:n,reason:t,confidence:o,timestamp:Date.now()};this.recommendedTabs.push(a),this.recommendedTabs=this.recommendedTabs.sort((e,n)=>n.confidence-e.confidence).slice(0,5),console.log("ğŸ“± ALRA: Added recommended tab:",n)}async generateRecommendedTabs(){const e=window.location.href,n=document.title;this.recommendedTabs=[];try{const t=await this.getAIRecommendations(e,n);if(t&&t.length>0)return void t.forEach(e=>{this.addRecommendedTab(e.url,e.title,e.reason,e.confidence)})}catch(e){console.debug("âš ï¸ ALRA: AI recommendations unavailable, using heuristics")}this.generateHeuristicRecommendations(e,n)}async getAIRecommendations(e,n){return new Promise(t=>{const o=`sync-${Date.now()}`,a=n=>{const i=n;if(i.detail.requestId===o)if(window.removeEventListener("ALRA_AI_RESPONSE",a),i.detail.success&&i.detail.result){const n=this.parseAIRecommendations(i.detail.result,e);t(n)}else t([])};window.addEventListener("ALRA_AI_RESPONSE",a),window.dispatchEvent(new CustomEvent("ALRA_AI_REQUEST",{detail:{action:"WRITE",data:{prompt:`Based on this webpage "${n}" at ${e}, suggest 3 related pages or topics the user might want to explore next. \n\nFormat each as:\n[URL or search term] | [Title/Topic] | [Brief reason]\n\nExamples:\nhttps://example.com/related | Related Article Title | Continues the topic\n"machine learning basics" | Search: ML Fundamentals | Good starting point\nhttps://github.com/example | GitHub Repository | Practical implementation`,tone:"professional",length:"short"},requestId:o}})),setTimeout(()=>{window.removeEventListener("ALRA_AI_RESPONSE",a),t([])},5e3)})}parseAIRecommendations(e,n){const t=e.split("\n").filter(e=>e.trim()),o=[];for(const e of t){const n=e.split("|").map(e=>e.trim());if(n.length>=3){const e=n[0].replace(/^["']|["']$/g,""),t=n[1].replace(/^["']|["']$/g,""),a=n[2].replace(/^["']|["']$/g,"");let i=e;if(e.startsWith("http")||(i=`https://www.google.com/search?q=${encodeURIComponent(e)}`),o.push({url:i,title:t,reason:a,confidence:.85,timestamp:Date.now()}),o.length>=3)break}}return o}generateHeuristicRecommendations(e,n){if(e.includes("github.com"))this.addRecommendedTab("https://github.com/trending","GitHub Trending","Discover popular projects",.8),e.match(/github\.com\/([^\/]+\/[^\/]+)/)&&this.addRecommendedTab(`${e}/issues`,"Repository Issues","Check issues and discussions",.75);else if(e.includes("wikipedia.org"))this.addRecommendedTab("https://en.wikipedia.org/wiki/Special:Random","Random Wikipedia Article","Discover something new",.7);else if(e.includes("youtube.com/watch"))this.addRecommendedTab("https://www.youtube.com","YouTube Home","Recommended videos",.8);else if(e.includes("reddit.com"))this.addRecommendedTab("https://www.reddit.com/r/popular","Popular on Reddit","Trending discussions",.75);else{const t=new URL(e).hostname;this.addRecommendedTab(`https://www.google.com/search?q=${encodeURIComponent(n)}`,`Search: ${n}`,"Find related content",.7),this.addRecommendedTab(`https://${t}`,"Homepage","Explore more from this site",.6)}}async syncToCloud(){if(!this.syncEnabled)return;try{chrome.runtime.id}catch(e){return}0===this.recommendedTabs.length&&await this.generateRecommendedTabs();const e=await n.getMetrics(),t={deviceType:this.deviceType,recommendedTabs:this.recommendedTabs,currentPage:{url:window.location.href,title:document.title,scrollPosition:window.scrollY},metrics:e,lastSync:Date.now(),sessionId:`session-${Date.now()}`};try{await chrome.storage.sync.set({alra_session:t}),chrome.runtime.sendMessage({action:"SYNC_TABS",tabs:this.recommendedTabs.map(e=>({url:e.url,title:`[ALRA Recommended] ${e.title}`}))}),console.log("â˜ï¸ ALRA: Session synced to Chrome Storage:",t.recommendedTabs.length,"tabs"),console.log('ğŸ“± ALRA: Tabs will appear in Chrome\'s "Recent Tabs" on all your devices!')}catch(e){e instanceof Error&&!e.message.includes("Extension context invalidated")&&console.debug("ALRA: Sync failed:",e.message)}}async checkForSyncedTabs(){try{const e=await chrome.storage.sync.get("alra_session");if(e.alra_session){const n=e.alra_session,t=(Date.now()-n.lastSync)/36e5;"desktop"===n.deviceType&&t<24&&this.showRecommendedTabsModal(n)}}catch(e){console.error("âŒ ALRA: Error checking synced tabs:",e)}}showRecommendedTabsModal(e){const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.5);\n      backdrop-filter: blur(4px);\n      z-index: 2147483646;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      animation: fadeIn 0.3s ease-out;\n    ";const t=document.createElement("div");t.style.cssText="\n      background: white;\n      border-radius: 20px;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      width: 90%;\n      max-width: 480px;\n      max-height: 80vh;\n      overflow: hidden;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    ";const o=document.createElement("div");o.style.cssText="\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 24px;\n      text-align: center;\n    ",o.innerHTML=`\n      <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“±â†’ğŸ’»</div>\n      <div style="font-size: 22px; font-weight: 700; margin-bottom: 8px;">Welcome Back!</div>\n      <div style="font-size: 14px; opacity: 0.9;">Synced from your ${e.deviceType} â€¢ ${this.timeAgo(e.lastSync)}</div>\n    `;const a=document.createElement("div");a.style.cssText="\n      padding: 24px;\n      max-height: 400px;\n      overflow-y: auto;\n    ";const i=document.createElement("div");i.style.cssText="\n      font-size: 16px;\n      font-weight: 700;\n      color: #1F2937;\n      margin-bottom: 16px;\n    ",i.textContent=`ğŸ“Œ Recommended Tabs (${e.recommendedTabs.length})`,a.appendChild(i),e.recommendedTabs.forEach((e,t)=>{const o=document.createElement("div");o.style.cssText=`\n        background: #F9FAFB;\n        border: 1.5px solid #E5E7EB;\n        border-radius: 12px;\n        padding: 16px;\n        margin-bottom: 12px;\n        cursor: pointer;\n        transition: all 0.2s;\n        animation: slideInCard 0.3s ease-out ${.1*t}s both;\n      `,o.onmouseover=()=>{o.style.borderColor="#667eea",o.style.boxShadow="0 4px 12px rgba(102, 126, 234, 0.2)",o.style.transform="translateY(-2px)"},o.onmouseout=()=>{o.style.borderColor="#E5E7EB",o.style.boxShadow="none",o.style.transform="translateY(0)"},o.innerHTML=`\n        <div style="font-size: 15px; font-weight: 600; color: #1F2937; margin-bottom: 6px;">${e.title}</div>\n        <div style="font-size: 13px; color: #6B7280; margin-bottom: 8px;">${e.reason}</div>\n        <div style="display: flex; align-items: center; gap: 8px;">\n          <div style="font-size: 11px; color: #667eea; font-weight: 600;">AI CONFIDENCE: ${Math.round(100*e.confidence)}%</div>\n          <div style="flex: 1; height: 4px; background: #E5E7EB; border-radius: 2px; overflow: hidden;">\n            <div style="height: 100%; width: ${100*e.confidence}%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 1s ease-out;"></div>\n          </div>\n        </div>\n      `,o.onclick=()=>{window.open(e.url,"_blank"),n.remove()},a.appendChild(o)}),t.appendChild(o),t.appendChild(a);const s=document.createElement("div");s.style.cssText="\n      padding: 20px 24px;\n      border-top: 1px solid #E5E7EB;\n      display: flex;\n      gap: 12px;\n    ";const r=document.createElement("button");r.textContent="Maybe Later",r.style.cssText="\n      flex: 1;\n      padding: 12px;\n      background: #F3F4F6;\n      border: none;\n      border-radius: 10px;\n      font-weight: 600;\n      color: #6B7280;\n      cursor: pointer;\n      transition: all 0.2s;\n    ",r.onmouseover=()=>r.style.background="#E5E7EB",r.onmouseout=()=>r.style.background="#F3F4F6",r.onclick=()=>n.remove();const l=document.createElement("button");l.textContent=`Open All ${e.recommendedTabs.length} Tabs`,l.style.cssText="\n      flex: 2;\n      padding: 12px;\n      background: linear-gradient(135deg, #667eea, #764ba2);\n      border: none;\n      border-radius: 10px;\n      font-weight: 600;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s;\n    ",l.onmouseover=()=>{l.style.transform="translateY(-2px)",l.style.boxShadow="0 4px 12px rgba(102, 126, 234, 0.4)"},l.onmouseout=()=>{l.style.transform="translateY(0)",l.style.boxShadow="none"},l.onclick=()=>{e.recommendedTabs.forEach(e=>{window.open(e.url,"_blank")}),n.remove(),this.showToast(`âœ… Opened ${e.recommendedTabs.length} recommended tabs!`)},s.appendChild(r),s.appendChild(l),t.appendChild(s),n.appendChild(t);const d=document.createElement("style");d.textContent="\n      @keyframes fadeIn {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n      @keyframes slideUp {\n        from {\n          opacity: 0;\n          transform: translate(-50%, -45%);\n        }\n        to {\n          opacity: 1;\n          transform: translate(-50%, -50%);\n        }\n      }\n      @keyframes slideInCard {\n        from {\n          opacity: 0;\n          transform: translateX(-20px);\n        }\n        to {\n          opacity: 1;\n          transform: translateX(0);\n        }\n      }\n    ",document.head.appendChild(d),document.body.appendChild(n);const c=e=>{"Escape"===e.key&&(n.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c)}async showSyncSettings(){const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.5);\n      backdrop-filter: blur(4px);\n      z-index: 2147483646;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      animation: fadeIn 0.2s ease-out;\n    ";const n=document.createElement("div");n.style.cssText="\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      width: 90%;\n      max-width: 420px;\n      overflow: hidden;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ",n.innerHTML=`\n      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px;">\n        <div style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">ğŸ”„ Cross-Device Sync</div>\n        <div style="font-size: 13px; opacity: 0.9;">Sync tabs across your devices</div>\n      </div>\n      \n      <div style="padding: 24px;">\n        <div style="margin-bottom: 20px;">\n          <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Current Device</div>\n          <div style="background: #F3F4F6; padding: 12px; border-radius: 8px; font-size: 14px; color: #6B7280;">\n            ğŸ“± ${this.deviceType.charAt(0).toUpperCase()+this.deviceType.slice(1)}\n          </div>\n        </div>\n        \n        <div style="margin-bottom: 20px;">\n          <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Sync Status</div>\n          <div style="background: ${this.syncEnabled?"#ECFDF5":"#FEF2F2"}; padding: 12px; border-radius: 8px; font-size: 14px; color: ${this.syncEnabled?"#065F46":"#991B1B"};">\n            ${this.syncEnabled?"âœ… Enabled":"âŒ Disabled"}\n          </div>\n        </div>\n        \n        <div style="background: #EFF6FF; border-left: 3px solid #3B82F6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">\n          <div style="font-size: 13px; color: #1E40AF; line-height: 1.5;">\n            <strong>How it works:</strong><br>\n            â€¢ When you close tabs, ALRA saves recommended next tabs to Chrome Sync<br>\n            â€¢ Open Chrome on ANY device (desktop, mobile, tablet)<br>\n            â€¢ Access synced tabs from Chrome's native "Recent Tabs" menu<br>\n            â€¢ No extension needed on other devices - uses Chrome's built-in sync!\n          </div>\n        </div>\n        \n        ${this.syncEnabled?`\n        <div style="background: #ECFDF5; border-left: 3px solid #10B981; padding: 16px; border-radius: 8px; margin-bottom: 20px;">\n          <div style="font-size: 13px; color: #065F46; line-height: 1.5;">\n            <strong>âœ… Sync is Active!</strong><br><br>\n            <strong>To verify on other devices:</strong><br>\n            1. Open Chrome on another device (phone/tablet)<br>\n            2. Tap the â‹® menu (three dots)<br>\n            3. Select "Recent tabs"<br>\n            4. Look for tabs prefixed with "[ALRA Recommended]"<br><br>\n            <em>Synced ${this.recommendedTabs.length} recommended tabs</em>\n          </div>\n        </div>\n        `:""}\n        \n        <div style="display: flex; gap: 12px;">\n          <button id="sync-close" style="flex: 1; padding: 12px; background: #F3F4F6; border: none; border-radius: 10px; font-weight: 600; color: #6B7280; cursor: pointer;">\n            Close\n          </button>\n          <button id="sync-toggle" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer;">\n            ${this.syncEnabled?"Disable":"Enable"} Sync\n          </button>\n        </div>\n      </div>\n    `,e.onclick=n=>{n.target===e&&e.remove()},n.querySelector("#sync-close").addEventListener("click",()=>e.remove()),n.querySelector("#sync-toggle").addEventListener("click",async()=>{this.syncEnabled?await this.disableSync():await this.enableSync(),e.remove()}),e.appendChild(n),document.body.appendChild(e)}timeAgo(e){const n=Math.floor((Date.now()-e)/1e3);return n<60?"just now":n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:`${Math.floor(n/86400)}d ago`}showToast(e){const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      bottom: 24px;\n      right: 24px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 14px 20px;\n      border-radius: 10px;\n      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);\n      z-index: 2147483647;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n      animation: slideIn 0.3s ease-out;\n    ",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="all 0.3s ease-out",setTimeout(()=>n.remove(),300)},3e3)}}class k{constructor(){this.enabled=!1,this.focusTopic="",this.focusKeywords=[],this.blockedOverlay=null,this.initializeMode()}async initializeMode(){const e=await chrome.storage.local.get("productivityMode");e.productivityMode&&(this.enabled=e.productivityMode.enabled||!1,this.focusTopic=e.productivityMode.topic||"",this.focusKeywords=e.productivityMode.keywords||[],this.enabled&&this.checkAndBlock())}async enable(){await this.setFocusTopic(),this.enabled=!0,await chrome.storage.local.set({productivityMode:{enabled:!0,topic:this.focusTopic,keywords:this.focusKeywords,startTime:Date.now()}}),this.showToast(`ğŸ¯ Productivity Mode ON: Focus on "${this.focusTopic}"`),console.log("ğŸ¯ ALRA: Productivity mode enabled. Focus:",this.focusTopic)}async disable(){this.enabled=!1,await chrome.storage.local.set({productivityMode:{enabled:!1}}),this.blockedOverlay&&(this.blockedOverlay.remove(),this.blockedOverlay=null),this.showToast("âœ… Productivity Mode OFF"),console.log("âœ… ALRA: Productivity mode disabled")}async setFocusTopic(){const e=window.location.href,n=document.title;if(e.includes("github.com")){const n=e.match(/github\.com\/([^\/]+)\/([^\/]+)/);n&&(this.focusTopic=`${n[2]} development`,this.focusKeywords=[n[1],n[2],"github","code","programming","development"])}else if(e.includes("stackoverflow.com")||e.includes("stackexchange.com"))this.focusTopic="Programming & Development",this.focusKeywords=["code","programming","development","stackoverflow","github","docs","documentation"];else if(e.includes("wikipedia.org")){const e=n.match(/^(.+?)\s*[-â€“â€”]\s*Wikipedia/);e&&(this.focusTopic=e[1],this.focusKeywords=e[1].toLowerCase().split(" "))}else e.includes("youtube.com/watch")?(this.focusTopic=n.replace(" - YouTube",""),this.focusKeywords=n.toLowerCase().split(" ").filter(e=>e.length>3)):(this.focusTopic=n,this.focusKeywords=n.toLowerCase().split(" ").filter(e=>e.length>3).slice(0,5));const t=new URL(e).hostname.replace("www.","");this.focusKeywords.push(t)}checkAndBlock(){const e=window.location.href,n=document.title.toLowerCase();this.isPageRelated(e,n)?this.blockedOverlay&&(this.blockedOverlay.remove(),this.blockedOverlay=null):this.showBlockScreen()}isPageRelated(e,n){const t=e.toLowerCase(),o=n.toLowerCase();if(t.includes("chrome://")||t.includes("chrome-extension://")||"about:blank"===t)return!0;for(const e of this.focusKeywords)if(t.includes(e.toLowerCase())||o.includes(e.toLowerCase()))return!0;const a=new URL(e).hostname.replace("www.","");for(const e of this.focusKeywords)if(a.includes(e.toLowerCase()))return!0;return!1}showBlockScreen(){if(this.blockedOverlay&&document.body.contains(this.blockedOverlay))return;this.blockedOverlay=document.createElement("div"),this.blockedOverlay.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: #000;\n      z-index: 2147483647;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ",this.blockedOverlay.innerHTML=`\n      <div style="text-align: center; max-width: 600px; padding: 40px;">\n        <div style="font-size: 120px; margin-bottom: 24px;">ğŸ¯</div>\n        <div style="font-size: 48px; font-weight: 700; color: white; margin-bottom: 16px; letter-spacing: -1px;">\n          BE PRODUCTIVE\n        </div>\n        <div style="font-size: 20px; color: rgba(255, 255, 255, 0.7); margin-bottom: 32px; line-height: 1.5;">\n          This page isn't related to your current focus:<br>\n          <strong style="color: white;">"${this.focusTopic}"</strong>\n        </div>\n        <div style="font-size: 16px; color: rgba(255, 255, 255, 0.5); margin-bottom: 40px;">\n          Stay focused on what matters. Unrelated pages are blocked.\n        </div>\n        <button id="alra-productivity-disable" style="\n          background: white;\n          color: #000;\n          border: none;\n          padding: 16px 32px;\n          border-radius: 12px;\n          font-size: 16px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n        ">\n          Disable Productivity Mode\n        </button>\n      </div>\n    `;const e=this.blockedOverlay.querySelector("#alra-productivity-disable");e&&(e.addEventListener("mouseenter",e=>{e.target.style.transform="scale(1.05)",e.target.style.boxShadow="0 8px 24px rgba(255, 255, 255, 0.3)"}),e.addEventListener("mouseleave",e=>{e.target.style.transform="scale(1)",e.target.style.boxShadow="none"}),e.addEventListener("click",()=>{this.disable()})),document.body.appendChild(this.blockedOverlay)}async showSettings(){const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.5);\n      backdrop-filter: blur(4px);\n      z-index: 2147483646;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      animation: fadeIn 0.2s ease-out;\n    ";const n=document.createElement("div");n.style.cssText="\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      width: 90%;\n      max-width: 420px;\n      overflow: hidden;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    ",n.innerHTML=`\n      <div style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; padding: 24px;">\n        <div style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">ğŸ¯ Productivity Mode</div>\n        <div style="font-size: 13px; opacity: 0.9;">Block distractions, stay focused</div>\n      </div>\n      \n      <div style="padding: 24px;">\n        <div style="margin-bottom: 20px;">\n          <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">Status</div>\n          <div style="background: ${this.enabled?"#FEF3C7":"#F3F4F6"}; padding: 12px; border-radius: 8px; font-size: 14px; color: ${this.enabled?"#92400E":"#6B7280"};">\n            ${this.enabled?`ğŸ¯ Active - Focusing on "${this.focusTopic}"`:"âŒ Disabled"}\n          </div>\n        </div>\n        \n        <div style="background: #FEF3C7; border-left: 3px solid #F59E0B; padding: 16px; border-radius: 8px; margin-bottom: 20px;">\n          <div style="font-size: 13px; color: #92400E; line-height: 1.5;">\n            <strong>How it works:</strong><br>\n            â€¢ ALRA detects your current focus topic from the active page<br>\n            â€¢ Any unrelated pages will be blocked with a "Be Productive" screen<br>\n            â€¢ You can only access pages related to your focus topic<br>\n            â€¢ Perfect for deep work sessions!\n          </div>\n        </div>\n        \n        <div style="display: flex; gap: 12px;">\n          <button id="productivity-close" style="flex: 1; padding: 12px; background: #F3F4F6; border: none; border-radius: 10px; font-weight: 600; color: #6B7280; cursor: pointer;">\n            Close\n          </button>\n          <button id="productivity-toggle" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #F59E0B, #D97706); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer;">\n            ${this.enabled?"Disable":"Enable"} Mode\n          </button>\n        </div>\n      </div>\n    `,e.onclick=n=>{n.target===e&&e.remove()},n.querySelector("#productivity-close").addEventListener("click",()=>e.remove()),n.querySelector("#productivity-toggle").addEventListener("click",async()=>{this.enabled?await this.disable():await this.enable(),e.remove()}),e.appendChild(n),document.body.appendChild(e)}isEnabled(){return this.enabled}showToast(e){const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      bottom: 24px;\n      right: 24px;\n      background: linear-gradient(135deg, #F59E0B, #D97706);\n      color: white;\n      padding: 14px 20px;\n      border-radius: 10px;\n      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);\n      z-index: 2147483647;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n      animation: slideIn 0.3s ease-out;\n    ",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="all 0.3s ease-out",setTimeout(()=>n.remove(),300)},4e3)}}class E{constructor(){this.waveOverlay=null,this.resultContainer=null,this.isProcessing=!1,this.aiAvailable=!1,this.init(),this.injectStyles(),this.checkAIAvailability()}async checkAIAvailability(){try{await new Promise(e=>setTimeout(e,1e3));const e=await this.sendToAIBridge("CHECK_AVAILABILITY",{});this.aiAvailable="available"===e,this.aiAvailable||console.warn("ALRA: Gemini Nano AI not available. Multimodal features will show fallback.")}catch(e){this.aiAvailable=!1,console.warn("ALRA: Could not check AI availability:",e)}}init(){document.addEventListener("contextmenu",e=>{const n=e.target;"IMG"===n.tagName&&(window.__alraContextImage=n)})}injectStyles(){if(document.querySelector("#alra-wave-styles"))return;const e=document.createElement("style");e.id="alra-wave-styles",e.textContent='\n      /* Wave Animation Overlay */\n      .alra-wave-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        z-index: 2147483646;\n        overflow: hidden;\n      }\n\n      .alra-wave {\n        position: absolute;\n        width: 200%;\n        height: 200%;\n        top: -50%;\n        left: -50%;\n        background: radial-gradient(\n          circle at center,\n          rgba(59, 130, 246, 0.4) 0%,\n          rgba(59, 130, 246, 0.2) 30%,\n          rgba(59, 130, 246, 0.1) 60%,\n          transparent 100%\n        );\n        animation: alra-wave-pulse 2s ease-in-out infinite;\n      }\n\n      .alra-wave-1 { animation-delay: 0s; }\n      .alra-wave-2 { animation-delay: 0.4s; }\n      .alra-wave-3 { animation-delay: 0.8s; }\n\n      @keyframes alra-wave-pulse {\n        0% {\n          transform: scale(0.8) rotate(0deg);\n          opacity: 0;\n        }\n        50% {\n          opacity: 1;\n        }\n        100% {\n          transform: scale(1.3) rotate(180deg);\n          opacity: 0;\n        }\n      }\n\n      .alra-wave-overlay.alra-wave-fadeout .alra-wave {\n        animation: alra-wave-fadeout 0.8s ease-out forwards;\n      }\n\n      @keyframes alra-wave-fadeout {\n        to {\n          opacity: 0;\n          transform: scale(1.5);\n        }\n      }\n\n      /* Inline Result Container */\n      .alra-result-container {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        max-width: 450px;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n        border-radius: 16px;\n        padding: 24px;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n        z-index: 2147483645;\n        animation: alra-result-slidein 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      }\n\n      @keyframes alra-result-slidein {\n        from {\n          transform: translateX(500px);\n          opacity: 0;\n        }\n        to {\n          transform: translateX(0);\n          opacity: 1;\n        }\n      }\n\n      .alra-result-container.alra-result-fadeout {\n        animation: alra-result-fadeout 0.4s ease-out forwards;\n      }\n\n      @keyframes alra-result-fadeout {\n        to {\n          transform: translateX(500px);\n          opacity: 0;\n        }\n      }\n\n      .alra-result-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 16px;\n      }\n\n      .alra-result-title {\n        font-size: 18px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .alra-result-close {\n        background: rgba(255, 255, 255, 0.2);\n        border: none;\n        color: white;\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        cursor: pointer;\n        font-size: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n      }\n\n      .alra-result-close:hover {\n        background: rgba(255, 255, 255, 0.3);\n        transform: scale(1.1);\n      }\n\n      .alra-result-content {\n        font-size: 14px;\n        line-height: 1.6;\n        max-height: 400px;\n        overflow-y: auto;\n        background: rgba(255, 255, 255, 0.1);\n        padding: 16px;\n        border-radius: 12px;\n        backdrop-filter: blur(10px);\n      }\n\n      .alra-result-content::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .alra-result-content::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 4px;\n      }\n\n      .alra-result-content::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n        border-radius: 4px;\n      }\n\n      .alra-result-actions {\n        margin-top: 16px;\n        display: flex;\n        gap: 8px;\n      }\n\n      .alra-result-btn {\n        background: rgba(255, 255, 255, 0.2);\n        border: 1px solid rgba(255, 255, 255, 0.3);\n        color: white;\n        padding: 8px 16px;\n        border-radius: 8px;\n        cursor: pointer;\n        font-size: 13px;\n        font-weight: 500;\n        transition: all 0.2s;\n        flex: 1;\n      }\n\n      .alra-result-btn:hover {\n        background: rgba(255, 255, 255, 0.3);\n        transform: translateY(-2px);\n      }\n\n      /* Quick Action Menu */\n      .alra-quick-menu {\n        position: fixed;\n        bottom: 80px;\n        right: 20px;\n        background: white;\n        border-radius: 16px;\n        padding: 16px;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n        z-index: 2147483645;\n        animation: alra-menu-popup 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n        min-width: 280px;\n      }\n\n      @keyframes alra-menu-popup {\n        from {\n          transform: scale(0.8);\n          opacity: 0;\n        }\n        to {\n          transform: scale(1);\n          opacity: 1;\n        }\n      }\n\n      .alra-quick-menu-title {\n        font-size: 16px;\n        font-weight: 600;\n        margin-bottom: 12px;\n        color: #1f2937;\n      }\n\n      .alra-quick-menu-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 12px;\n        border-radius: 10px;\n        cursor: pointer;\n        transition: all 0.2s;\n        margin-bottom: 8px;\n        background: #f3f4f6;\n      }\n\n      .alra-quick-menu-item:hover {\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n        transform: translateX(4px);\n      }\n\n      .alra-quick-menu-item:last-child {\n        margin-bottom: 0;\n      }\n\n      .alra-quick-menu-icon {\n        font-size: 24px;\n      }\n\n      .alra-quick-menu-text {\n        flex: 1;\n      }\n\n      .alra-quick-menu-label {\n        font-weight: 600;\n        font-size: 14px;\n      }\n\n      .alra-quick-menu-desc {\n        font-size: 12px;\n        opacity: 0.7;\n      }\n    ',document.head.appendChild(e)}showWaveAnimation(){this.hideWaveAnimation(),this.waveOverlay=document.createElement("div"),this.waveOverlay.className="alra-wave-overlay",this.waveOverlay.innerHTML='\n      <div class="alra-wave alra-wave-1"></div>\n      <div class="alra-wave alra-wave-2"></div>\n      <div class="alra-wave alra-wave-3"></div>\n    ',document.body.appendChild(this.waveOverlay)}hideWaveAnimation(){return new Promise(e=>{this.waveOverlay?(this.waveOverlay.classList.add("alra-wave-fadeout"),setTimeout(()=>{this.waveOverlay?.remove(),this.waveOverlay=null,e()},800)):e()})}showResult(e,n,t="ğŸ¤–"){this.hideResult(),this.resultContainer=document.createElement("div"),this.resultContainer.className="alra-result-container",this.resultContainer.innerHTML=`\n      <div class="alra-result-header">\n        <div class="alra-result-title">\n          <span>${t}</span>\n          <span>${e}</span>\n        </div>\n        <button class="alra-result-close">Ã—</button>\n      </div>\n      <div class="alra-result-content">${n}</div>\n      <div class="alra-result-actions">\n        <button class="alra-result-btn alra-copy-btn">ğŸ“‹ Copy</button>\n        <button class="alra-result-btn alra-share-btn">ğŸ”— Share</button>\n      </div>\n    `;const o=this.resultContainer.querySelector(".alra-result-close");o?.addEventListener("click",()=>this.hideResult());const a=this.resultContainer.querySelector(".alra-copy-btn");a?.addEventListener("click",()=>{navigator.clipboard.writeText(n),a.textContent="âœ“ Copied!",setTimeout(()=>{a.textContent="ğŸ“‹ Copy"},2e3)});const i=this.resultContainer.querySelector(".alra-share-btn");i?.addEventListener("click",async()=>{try{await navigator.share({text:n,title:e}),i.textContent="âœ“ Shared!"}catch(e){console.log("Share not supported")}}),document.body.appendChild(this.resultContainer),setTimeout(()=>this.hideResult(),3e4)}hideResult(){return new Promise(e=>{this.resultContainer?(this.resultContainer.classList.add("alra-result-fadeout"),setTimeout(()=>{this.resultContainer?.remove(),this.resultContainer=null,e()},400)):e()})}showFallbackMessage(){this.showResult("âš ï¸ AI Not Available",'<div style="text-align: center;">\n        <p style="margin-bottom: 12px;">Gemini Nano AI is not currently available in your browser.</p>\n        <p style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">To enable ALRA\'s AI features:</p>\n        <ol style="text-align: left; font-size: 13px; opacity: 0.9; line-height: 1.8;">\n          <li>Use <strong>Chrome Canary</strong> or <strong>Chrome Dev</strong> (version 127+)</li>\n          <li>Go to <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">chrome://flags</code></li>\n          <li>Enable these flags:\n            <ul style="margin-top: 6px;">\n              <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">Prompt API for Gemini Nano</code></li>\n              <li><code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">Summarization API for Gemini Nano</code></li>\n            </ul>\n          </li>\n          <li>Restart Chrome</li>\n          <li>Go to <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">chrome://components</code></li>\n          <li>Find "Optimization Guide On Device Model" and click <strong>Check for update</strong></li>\n          <li>Wait for Gemini Nano to download (~1.7GB)</li>\n        </ol>\n        <p style="font-size: 13px; opacity: 0.9; margin-top: 12px;">Once enabled, ALRA will have access to powerful on-device AI! ğŸš€</p>\n      </div>',"âš ï¸")}async summarizeImage(e){if(this.isProcessing)return;if(!this.aiAvailable)return void this.showFallbackMessage();const n=e||window.__alraContextImage;if(n)try{this.isProcessing=!0,this.showWaveAnimation();const e=document.createElement("canvas");e.width=n.naturalWidth||n.width,e.height=n.naturalHeight||n.height;const t=e.getContext("2d");t?.drawImage(n,0,0);const o=await new Promise(n=>{e.toBlob(e=>n(e),"image/png")}),a=await this.sendToAIBridge("ANALYZE_IMAGE",{prompt:"Analyze this image in detail. Describe what you see, identify key elements, and provide insights about the context, purpose, or meaning.",imageBlob:o});await this.hideWaveAnimation(),this.showResult("ğŸ–¼ï¸ Image Analysis",a,"ğŸ–¼ï¸")}catch(e){await this.hideWaveAnimation(),this.showResult("Error",`Failed to analyze image: ${e}`,"âš ï¸")}finally{this.isProcessing=!1}else this.showResult("Error","No image found. Please right-click on an image first.","âš ï¸")}async summarizeYouTubeVideo(){if(!this.isProcessing)if(this.aiAvailable)if(window.location.hostname.includes("youtube.com"))try{this.isProcessing=!0,this.showWaveAnimation();const e=document.querySelector("h1.ytd-video-primary-info-renderer")?.textContent?.trim()||document.querySelector("h1 yt-formatted-string")?.textContent?.trim()||"Unknown Video",n=document.querySelector("#description-inline-expander")?.textContent?.trim()?.substring(0,500)||"No description available",t=new URLSearchParams(window.location.search).get("v"),o=`\nVideo Title: ${e}\nDescription: ${n}\nThumbnail: ${t?`https://img.youtube.com/vi/${t}/maxresdefault.jpg`:""}\n`,a=await this.sendToAIBridge("ANALYZE_VIDEO",{prompt:"Based on this YouTube video information, provide: 1) A concise summary, 2) Key topics covered, 3) Target audience, 4) Main takeaways, 5) Educational or entertainment value.",context:o});await this.hideWaveAnimation(),this.showResult("ğŸ¥ Video Summary",a,"ğŸ¥")}catch(e){await this.hideWaveAnimation(),this.showResult("Error",`Failed to summarize video: ${e}`,"âš ï¸")}finally{this.isProcessing=!1}else this.showResult("Error","This feature only works on YouTube pages.","âš ï¸");else this.showFallbackMessage()}async proofreadText(e){if(this.isProcessing)return;if(!this.aiAvailable)return void this.showFallbackMessage();const n=e||window.getSelection()?.toString().trim();if(n)try{this.isProcessing=!0,this.showWaveAnimation();const e=await this.sendToAIBridge("PROOFREAD",{text:n});await this.hideWaveAnimation(),this.showResult("ğŸ“ Proofread Text",e,"ğŸ“")}catch(e){await this.hideWaveAnimation(),this.showResult("Error",`Failed to proofread: ${e}`,"âš ï¸")}finally{this.isProcessing=!1}else this.showResult("Error","Please select some text first.","âš ï¸")}async translateText(e,n="es"){if(this.isProcessing)return;if(!this.aiAvailable)return void this.showFallbackMessage();const t=e||window.getSelection()?.toString().trim();if(t)try{this.isProcessing=!0,this.showWaveAnimation();const e=await this.sendToAIBridge("TRANSLATE",{text:t,targetLanguage:n,sourceLanguage:"en"});await this.hideWaveAnimation(),this.showResult(`ğŸŒ Translation (${n.toUpperCase()})`,e,"ğŸŒ")}catch(e){await this.hideWaveAnimation(),this.showResult("Error",`Failed to translate: ${e}`,"âš ï¸")}finally{this.isProcessing=!1}else this.showResult("Error","Please select some text first.","âš ï¸")}async showQuickActions(){const e=document.querySelector(".alra-quick-menu");if(e)return void e.remove();const n=document.createElement("div");n.className="alra-quick-menu";const t=window.location.hostname.includes("youtube.com"),o=!!window.getSelection()?.toString().trim();let a='<div class="alra-quick-menu-title">ğŸ¤– Multimodal AI</div>';!!window.__alraContextImage&&(a+='\n        <div class="alra-quick-menu-item" data-action="image">\n          <div class="alra-quick-menu-icon">ğŸ–¼ï¸</div>\n          <div class="alra-quick-menu-text">\n            <div class="alra-quick-menu-label">Analyze Image</div>\n            <div class="alra-quick-menu-desc">Get AI insights</div>\n          </div>\n        </div>\n      '),t&&(a+='\n        <div class="alra-quick-menu-item" data-action="video">\n          <div class="alra-quick-menu-icon">ğŸ¥</div>\n          <div class="alra-quick-menu-text">\n            <div class="alra-quick-menu-label">Summarize Video</div>\n            <div class="alra-quick-menu-desc">Key topics & takeaways</div>\n          </div>\n        </div>\n      '),o&&(a+='\n        <div class="alra-quick-menu-item" data-action="proofread">\n          <div class="alra-quick-menu-icon">ğŸ“</div>\n          <div class="alra-quick-menu-text">\n            <div class="alra-quick-menu-label">Proofread Text</div>\n            <div class="alra-quick-menu-desc">Fix grammar & clarity</div>\n          </div>\n        </div>\n        <div class="alra-quick-menu-item" data-action="translate">\n          <div class="alra-quick-menu-icon">ğŸŒ</div>\n          <div class="alra-quick-menu-text">\n            <div class="alra-quick-menu-label">Translate</div>\n            <div class="alra-quick-menu-desc">To Spanish</div>\n          </div>\n        </div>\n      '),'<div class="alra-quick-menu-title">ğŸ¤– Multimodal AI</div>'!==a?(n.innerHTML=a,n.querySelectorAll(".alra-quick-menu-item").forEach(e=>{e.addEventListener("click",async()=>{const t=e.getAttribute("data-action");n.remove(),"image"===t?await this.summarizeImage():"video"===t?await this.summarizeYouTubeVideo():"proofread"===t?await this.proofreadText():"translate"===t&&await this.translateText()})}),document.body.appendChild(n),setTimeout(()=>n.remove(),1e4),setTimeout(()=>{const e=t=>{n.contains(t.target)||(n.remove(),document.removeEventListener("click",e))};document.addEventListener("click",e)},100)):this.showResult("Quick Actions","Right-click an image, visit YouTube, or select text to see available actions.","ğŸ’¡")}setupContextMenuListeners(){}async sendToAIBridge(e,n){return new Promise((t,o)=>{const a=`alra-ai-${Date.now()}-${Math.random()}`,i=e=>{e.data?.id===a&&(window.removeEventListener("message",i),e.data.error?o(e.data.error):t(e.data.result))};if(window.addEventListener("message",i),n.imageBlob){const t=new FileReader;t.onload=()=>{const o=t.result.split(",")[1];window.postMessage({type:"ALRA_AI_REQUEST",id:a,action:e,data:{...n,imageData:o,imageBlob:void 0}},"*")},t.readAsDataURL(n.imageBlob)}else window.postMessage({type:"ALRA_AI_REQUEST",id:a,action:e,data:n},"*");setTimeout(()=>{window.removeEventListener("message",i),o("AI request timed out")},3e4)})}}window.addEventListener("unhandledrejection",e=>{const n=e.reason;n&&n.message&&n.message.includes("Extension context invalidated")&&e.preventDefault()});let T=Date.now(),S=!1,C=null,R=null,L=null,z=null,I=null,P=null,$=null,M=!1;function F(){try{return chrome.runtime.id,!0}catch(e){return!1}}async function B(){console.log("ğŸ§  ALRA: Initializing on page:",window.location.hostname),console.log("ğŸ“„ ALRA: URL:",window.location.href),console.log("â° ALRA: Page load time:",(new Date).toLocaleTimeString());try{console.log("ğŸŒ‰ ALRA: Injecting AI Bridge..."),await new Promise(e=>{const n=document.createElement("script");n.src=chrome.runtime.getURL("injected-ai-bridge.js"),n.onload=()=>{console.log("âœ… ALRA: AI Bridge script injected"),n.remove()},n.onerror=()=>{console.log("âš ï¸ ALRA: AI Bridge script injection failed"),e(!1)},window.addEventListener("ALRA_AI_BRIDGE_READY",()=>{console.log("âœ… ALRA: AI Bridge is ready!"),e(!0)},{once:!0}),setTimeout(()=>e(!1),2e3),(document.head||document.documentElement).appendChild(n)})?console.log("âœ… ALRA: AI Bridge ready - Chrome AI APIs accessible!"):console.log("âš ï¸ ALRA: AI Bridge not available - using fallback methods"),function(){if(document.getElementById("alra-styles"))return;const e=document.createElement("style");e.id="alra-styles",e.textContent='\n    /* ALRA Container - Base styles */\n    .alra-container {\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      color: #333;\n      z-index: 999999;\n    }\n\n    /* ALRA Highlight - Glowing effects */\n    .alra-highlighted {\n      box-shadow: 0 0 15px rgba(66, 153, 225, 0.6) !important;\n      border-left: 4px solid #4299e1 !important;\n      padding-left: 10px !important;\n      background-color: rgba(66, 153, 225, 0.05) !important;\n      transition: all 0.3s ease;\n    }\n\n    .alra-highlighted:hover {\n      box-shadow: 0 0 25px rgba(66, 153, 225, 0.8) !important;\n      background-color: rgba(66, 153, 225, 0.1) !important;\n    }\n\n    /* ALRA Nudge - Action suggestion boxes */\n    .alra-nudge {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 16px;\n      border-radius: 8px;\n      margin: 16px 0;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n      cursor: pointer;\n      transition: all 0.3s ease;\n      max-width: 400px;\n    }\n\n    .alra-nudge:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);\n    }\n\n    /* Nudge colors */\n    .alra-nudge-suggested {\n      background-color: #f0f9f5;\n      border-left: 4px solid #48bb78;\n    }\n\n    .alra-nudge-optional {\n      background-color: #f0f5ff;\n      border-left: 4px solid #4299e1;\n    }\n\n    .alra-nudge-priority {\n      background-color: #fff5e6;\n      border-left: 4px solid #ed8936;\n    }\n  ',document.head.appendChild(e),console.log("âœ… ALRA: CSS styles injected")}();let t=null;try{t=await q({action:"GET_PREFERENCES"}),console.log("âœ… ALRA: Loaded preferences",t)}catch(e){console.debug("âš ï¸ ALRA: Could not load preferences, using defaults"),t={pageOptimizationEnabled:!0,summarizationEnabled:!0,predictionsEnabled:!0,nudgesEnabled:!0,metricsTrackingEnabled:!0,privacyMode:!1}}let a=null;try{a=await q({action:"GET_AI_STATUS"}),console.log("ğŸ¤– ALRA: AI APIs available:"),console.log("   Gemini Nano: "+(a.geminiNano?"âœ…":"âŒ")),console.log("   Summarizer:  "+(a.summarizer?"âœ…":"âŒ")),console.log("   Writer:      "+(a.writer?"âœ…":"âŒ"))}catch(e){console.debug("âš ï¸ ALRA: Could not check AI API status"),a={geminiNano:!1,summarizer:!1,writer:!1}}const i=function(){const e=document.body.innerText||document.body.textContent||"",n=[];document.querySelectorAll("h1, h2, h3, h4").forEach(e=>{const t=e.innerText;t&&t.length>0&&n.push(t)});const t=Array.from(document.querySelectorAll("img")),o=Array.from(document.querySelectorAll("a")),a=document.querySelectorAll("p, article, main"),i=[];a.forEach(e=>{const n=e;(n.innerText||"").length>100&&i.push(n)});let s="other";return window.location.hostname.includes("mail")?s="email":i.length>3&&e.length>1e3?s="article":e.toLowerCase().includes("price")||e.toLowerCase().includes("buy")?s="product":(window.location.hostname.includes("twitter")||window.location.hostname.includes("reddit")||window.location.hostname.includes("facebook"))&&(s="social"),{type:s,text_content:e,headings:n,images:t,links:o,main_text_blocks:i}}();console.log("âœ… ALRA: Analyzed page, found",i.main_text_blocks.length,"content blocks"),console.log(`   Page type detected: ${i.type}`),console.log(`   Content length: ${i.text_content.length} characters`),console.log(`   Headings found: ${i.headings.length}`),console.log(`   Images found: ${i.images.length}`),console.log(`   Links found: ${i.links.length}`),t.pageOptimizationEnabled&&await async function(e){console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ï¿½ ALRA: Initiating Phase 2 - Page Optimization"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");try{console.log("\nğŸ“‹ ALRA: Beginning comprehensive page analysis for optimization...");const n=["ins.adsbygoogle","div[id*='ad']","div[class*='advertisement']","[data-ad-format]","[data-adslot]","iframe[src*='ads']","iframe[src*='ad.']","iframe[id*='ad']","script[src*='analytics']","img[width='1'][height='1']","img[style*='display:none']"];let t=0,o=0;const a=[];console.log("\nğŸ” ALRA: Scanning for clutter elements.."),n.forEach(e=>{try{document.querySelectorAll(e).forEach(e=>{const n=e,i=n.offsetWidth*n.offsetHeight;i>0&&(t++,o+=i,a.push(n),n.style.display="none",n.style.visibility="hidden",n.style.opacity="0",n.style.height="0",n.style.width="0",n.style.overflow="hidden",n.setAttribute("data-alra-blocked","true"))})}catch(e){}}),['aside[class*="ad"]','div[class*="sidebar"][class*="ad"]',".advertisement",".ad-container",".banner-ad"].forEach(e=>{try{document.querySelectorAll(e).forEach(e=>{const n=e;n.offsetWidth>0&&n.offsetHeight>0&&(n.style.display="none",n.setAttribute("data-alra-blocked","true"),t++)})}catch(e){}}),console.log(`   âœ… Blocked ${t} ads/clutter elements`);const i=window.innerWidth*window.innerHeight,s=(o/i*100).toFixed(1);console.log("\nğŸ“Š ALRA: Clutter Analysis Complete"),console.log(`   â€¢ Clutter elements found: ${t}`),console.log(`   â€¢ Total clutter pixels: ${o}`),console.log(`   â€¢ Clutter percentage: ${s}% of viewport`),console.log(`   â€¢ Page type detected: ${e.type}`),console.log(`   â€¢ Content blocks analyzed: ${e.main_text_blocks.length}`),console.log("\nğŸ“– ALRA: Analyzing readability factors...");const r=document.querySelectorAll("p, article, main");console.log(`   â€¢ Text elements found: ${r.length}`);const l=document.querySelectorAll("h1, h2, h3, h4, h5, h6");console.log(`   â€¢ Heading elements found: ${l.length}`);const d=document.querySelectorAll("img");console.log(`   â€¢ Image elements found: ${d.length}`);const c=i-o,m=Math.min(100,Math.round(o/i*100));console.log("\nâœ¨ ALRA: Optimization Impact Projection"),console.log(`   â€¢ Projected readability improvement: +${m}%`),console.log(`   â€¢ Content visibility would improve: +${s}%`),console.log(`   â€¢ Page would display ${c} clean content pixels`),console.log("\nğŸ¨ ALRA: Injecting optimization CSS..."),function(){if(document.getElementById("alra-optimization-status-css"))return;const e=document.createElement("style");e.id="alra-optimization-status-css",e.textContent="\n    /* ALRA Optimization Status CSS */\n    .alra-optimization-status {\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      padding: 12px 16px;\n      border-radius: 8px;\n      font-size: 12px;\n      font-weight: 600;\n      z-index: 10000;\n      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n    }\n\n    /* Highlighted content (for Phase 2) */\n    .alra-highlighted-phase2 {\n      border-left: 3px solid #4299e1;\n      padding-left: 12px;\n      box-shadow: inset 0 0 8px rgba(66, 153, 225, 0.2);\n    }\n  ",document.head.appendChild(e),console.debug("âœ… ALRA: Optimization status CSS injected")}(),console.log("\nğŸ“¡ ALRA: Reporting optimization metrics to background..."),await q({action:"UPDATE_METRICS",data:{potentialAdsDetected:t,clutterPixels:o,clutterPercentage:parseFloat(s),readabilityImprovement:m,pageType:e.type,contentBlocksAnalyzed:e.main_text_blocks.length,headingsFound:l.length,imagesFound:d.length,optimizationEnabled:!0,optimizationPhase:2}}).catch(e=>{console.debug("âš ï¸ ALRA: Could not send optimization metrics",e)}),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("âœ… ALRA: Phase 2 page optimization analysis complete and ready!"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")}catch(e){console.debug("âš ï¸ ALRA: Page optimization analysis encountered an issue:",e)}}(i),t.summarizationEnabled&&await async function(t){try{if(console.log("ğŸ“ ALRA: Starting Phase 3 - Summarization..."),"article"===t.type&&t.main_text_blocks.length>0){console.log("ğŸ“° ALRA: Article detected, initializing Phase 3 summarization");const t=await async function(t={}){const a=performance.now();console.log("ğŸ“ ALRA: Initializing Phase 3 - Inline Summarization");const i={enabled:t.enabled??!0,minBlockWordCount:t.minBlockWordCount??100,maxBlockWordCount:t.maxBlockWordCount??5e3,maxSummariesPerPage:t.maxSummariesPerPage??5,inlineDisplayMode:t.inlineDisplayMode??"badge",prioritizePageSummary:t.prioritizePageSummary??!0},r={totalBlocksAnalyzed:0,blocksSummarized:0,totalWordsOriginal:0,totalWordsSummary:0,averageCompressionRatio:0,averageReadingTimeSaved:0,chromeAPIUsed:!1,extractiveUsed:!1,totalProcessingTime:0,summariesGenerated:[]};if(!i.enabled)return console.log("â­ï¸ ALRA: Summarization disabled"),r;const l=function(){console.log("ğŸ“– ALRA: Segmenting page content into blocks...");const e=[],n=["article","main",".article",".post",".content",".entry-content",".post-content",".article-content","#mw-content-text",".mw-parser-output","#bodyContent",".story-body",".article-body",".postArticle-content",".body",".Post","[data-test-id='post-content']","[role='main']","[role='article']"];let t=0;for(const a of n)if(document.querySelectorAll(a).forEach(n=>{const a=n.innerText||"",i=a.trim().split(/\s+/).length;if(i>=100&&i<=5e3){const s={id:"block-"+t++,type:"article",element:n,rawText:a,wordCount:i,sentences:o(a),importance:75,depth:0,estimatedReadingTime:Math.max(1,Math.ceil(i/200))};e.push(s)}}),e.length>0)break;if(0===e.length){console.log("ğŸ“– ALRA: No article containers found, analyzing paragraphs...");const n=document.querySelectorAll("p"),a=[];if(n.forEach(e=>{const n=e.innerText||"",t=n.trim().split(/\s+/).length;n.length>=300&&t>=50&&a.push(e)}),a.length>=2){const n=a.map(e=>e.innerText).join("\n\n"),i=n.trim().split(/\s+/).length;if(i>=100){const s={id:"block-"+t++,type:"article",element:a[0].parentElement||a[0],rawText:n,wordCount:i,sentences:o(n),importance:70,depth:0,estimatedReadingTime:Math.max(1,Math.ceil(i/200))};e.push(s)}}}return console.log(`âœ… ALRA: Segmented ${e.length} content blocks (${e.reduce((e,n)=>e+n.wordCount,0)} words total)`),e}();if(r.totalBlocksAnalyzed=l.length,0===l.length)return console.log("âš ï¸ ALRA: No content blocks found"),r;const d=l.slice(0,i.maxSummariesPerPage);console.log(`ğŸ“Š ALRA: Summarizing ${d.length} content blocks...`);for(const t of d)try{const o=await s(t);r.summariesGenerated.push(o),r.blocksSummarized++,r.totalWordsOriginal+=t.wordCount,r.totalWordsSummary+=o.summaryText.split(/\s+/).length,"chrome-api"===o.method?r.chromeAPIUsed=!0:r.extractiveUsed=!0;const a=new e({summary:{id:o.id,summaryText:o.summaryText,keyPoints:o.keyPoints,keywords:o.keywords,compressionRatio:o.compressionRatio,readingTime:o.readingTime,confidence:o.confidence},position:"top-right",autoShow:!1});window.alraSummaryModal=a,window.alraSummaryAvailable=!0,console.log("âœ… ALRA: Summary ready (access via floating menu)");const i=Math.round((t.wordCount-o.summaryText.split(" ").length)/200*60);await n.trackEvent({type:"article_summarized",value:i,timestamp:Date.now(),details:{originalWords:t.wordCount,summaryWords:o.summaryText.split(" ").length,compressionRatio:o.compressionRatio}})}catch(e){console.debug(`âš ï¸ ALRA: Failed to summarize ${t.id}`,e)}return r.blocksSummarized>0&&(r.averageCompressionRatio=r.totalWordsSummary/r.totalWordsOriginal,r.averageReadingTimeSaved=Math.round(r.totalWordsOriginal/200-r.totalWordsSummary/200)),r.totalProcessingTime=performance.now()-a,console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("âœ… ALRA: Phase 3 - Inline Summarization Complete"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log(`ğŸ“Š ALRA: Blocks analyzed: ${r.totalBlocksAnalyzed}`),console.log(`   Summarized: ${r.blocksSummarized}`),console.log(`   Words: ${r.totalWordsOriginal} â†’ ${r.totalWordsSummary}`),console.log(`   Compression: ${(100*r.averageCompressionRatio).toFixed(0)}%`),console.log(`   Time saved: ${r.averageReadingTimeSaved} minutes`),console.log("   Chrome API: "+(r.chromeAPIUsed?"Yes":"No")),console.log(`   Processing: ${r.totalProcessingTime.toFixed(0)}ms`),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),r}({enabled:!0,minBlockWordCount:100,maxBlockWordCount:5e3,maxSummariesPerPage:5,inlineDisplayMode:"badge",prioritizePageSummary:!0});if(t.blocksSummarized>0)try{await q({action:"UPDATE_PHASE3_METRICS",data:{blocksAnalyzed:t.totalBlocksAnalyzed,blocksSummarized:t.blocksSummarized,totalWordsOriginal:t.totalWordsOriginal,totalWordsSummary:t.totalWordsSummary,averageCompressionRatio:t.averageCompressionRatio,readingTimeSaved:t.averageReadingTimeSaved,chromeAPIUsed:t.chromeAPIUsed,extractiveUsed:t.extractiveUsed,processingTime:t.totalProcessingTime}}),console.log("âœ… ALRA: Phase 3 metrics reported to background")}catch(e){console.debug("âš ï¸ ALRA: Could not report Phase 3 metrics",e)}}}catch(e){console.error("âŒ ALRA: Phase 3 summarization initialization failed:",e),e instanceof Error&&(console.error("   Error message:",e.message),console.error("   Error stack:",e.stack))}}(i),t.predictionsEnabled&&await async function(){try{console.log("ğŸ”® ALRA: Starting Phase 4 - Tab Predictions...");const e=await async function(e){console.log("ğŸ”® ALRA: Initializing Phase 4 - Tab Prediction");const t={enabled:e.enabled??!0,minConfidenceThreshold:e.minConfidenceThreshold??.6,maxPredictionsShown:e.maxPredictionsShown??3,highlightPredictedLinks:e.highlightPredictedLinks??!0},o={patternsDetected:0,sequencesLearned:0,predictionsGenerated:0,avgConfidence:0,predictionsShown:0,accuracy:0};if(!t.enabled)return console.log("â­ï¸ ALRA: Tab Prediction disabled"),o;const a=await async function(){const e=[],n=document.querySelectorAll("a[href]");return console.log(`ğŸ”— ALRA: Analyzing ${n.length} links on page...`),n.forEach(n=>{const t=n,o=t.href,a=t.innerText.trim();if(!o||o.startsWith("javascript:")||"#"===o||0===a.length)return;let i=0,s="";const r=t.getBoundingClientRect();r.top>=0&&r.top<=window.innerHeight&&(i+=.3,s="visible");const l=window.getComputedStyle(t);parseInt(l.fontSize)>=18&&(i+=.2,s+=s?", large":"large"),(parseInt(l.fontWeight)||400)>=600&&(i+=.15,s+=s?", bold":"bold");const d=document.title.toLowerCase(),c=a.toLowerCase();d.split(/\s+/).filter(e=>e.length>3).some(e=>c.includes(e))&&(i+=.25,s+=s?", related":"related");const m=t.parentElement?.textContent?.toLowerCase()||"";(m.includes("see also")||m.includes("main article"))&&(i+=.3,s+=s?", suggested":"suggested");const p=t.className.toLowerCase();(p.includes("featured")||p.includes("recommended")||p.includes("related"))&&(i+=.2,s+=s?", featured":"featured"),i>=.4&&e.push({element:t,url:o,text:a.substring(0,100),confidence:Math.min(i,1),reason:s})}),e.sort((e,n)=>n.confidence-e.confidence),console.log(`âœ… ALRA: Found ${e.length} high-confidence link predictions`),e}();if(o.predictionsGenerated=a.length,a.length>0){const e=a.reduce((e,n)=>e+n.confidence,0)/a.length;o.avgConfidence=e,o.patternsDetected=a.length}return t.highlightPredictedLinks&&a.filter(e=>e.confidence>=t.minConfidenceThreshold).slice(0,t.maxPredictionsShown).forEach((e,t)=>{!function(e,t){const{element:o,confidence:a,reason:i}=e;if(o.classList.contains("alra-predicted-link"))return;const s=o.innerText.trim();o.classList.add("alra-predicted-link"),o.setAttribute("data-prediction-rank",t.toString()),o.setAttribute("data-confidence",(100*a).toFixed(0)),o.setAttribute("data-reason",i),o.style.cssText+="\n    position: relative;\n    background: rgba(37, 99, 235, 0.04);\n    border: 1.5px solid rgba(37, 99, 235, 0.15);\n    padding: 6px 12px !important;\n    border-radius: 8px;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    margin: 2px;\n    display: inline-block;\n  ";const r=document.createElement("span");r.className="alra-prediction-badge",r.style.cssText="\n    position: absolute;\n    top: -8px;\n    right: -8px;\n    background: #2563EB;\n    color: white;\n    border-radius: 10px;\n    padding: 2px 7px;\n    font-size: 10px;\n    font-weight: 700;\n    z-index: 10000;\n    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);\n    border: 2px solid white;\n    pointer-events: none;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    letter-spacing: 0.02em;\n  ",r.textContent=`${t}`,r.title=`Prediction #${t}: ${(100*a).toFixed(0)}% confidence - ${i}`;const l=document.createElement("div");l.className="alra-prediction-tooltip",l.style.cssText="\n    position: absolute;\n    bottom: calc(100% + 10px);\n    left: 50%;\n    transform: translateX(-50%) scale(0.95);\n    background: rgba(31, 41, 55, 0.96);\n    backdrop-filter: blur(10px);\n    color: white;\n    padding: 8px 12px;\n    border-radius: 8px;\n    font-size: 11px;\n    font-weight: 500;\n    white-space: nowrap;\n    z-index: 10001;\n    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);\n    opacity: 0;\n    pointer-events: none;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  ",l.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 8px;">\n      <span style="color: #60A5FA;">ğŸ¯ ${(100*a).toFixed(0)}%</span>\n      <span style="color: #9CA3AF;">Â·</span>\n      <span style="color: #E5E7EB; font-weight: 400;">${i}</span>\n    </div>\n  `;const d=document.createElement("div");d.style.cssText="\n    position: absolute;\n    top: 100%;\n    left: 50%;\n    transform: translateX(-50%);\n    width: 0;\n    height: 0;\n    border-left: 6px solid transparent;\n    border-right: 6px solid transparent;\n    border-top: 6px solid rgba(26, 32, 44, 0.95);\n  ",l.appendChild(d);const c=document.createElement("span");c.className="alra-link-wrapper",c.style.cssText="\n    position: relative;\n    display: inline-block;\n  ",o.parentElement&&(o.parentElement.insertBefore(c,o),c.appendChild(o),c.appendChild(r),c.appendChild(l)),o.addEventListener("click",async()=>{await n.trackEvent({type:"tab_predicted",value:1,timestamp:Date.now(),details:{confidence:a,reason:i,rank:t,url:e.url}})}),o.addEventListener("mouseenter",()=>{o.style.transform="translateY(-1px)",o.style.background="rgba(37, 99, 235, 0.08)",o.style.borderColor="rgba(37, 99, 235, 0.3)",o.style.boxShadow="0 4px 12px rgba(37, 99, 235, 0.15)",r.style.transform="scale(1.05)",l.style.opacity="1",l.style.transform="translateX(-50%) scale(1)"}),o.addEventListener("mouseleave",()=>{o.style.transform="translateY(0)",o.style.background="rgba(37, 99, 235, 0.04)",o.style.borderColor="rgba(37, 99, 235, 0.15)",o.style.boxShadow="none",r.style.transform="scale(1)",l.style.opacity="0",l.style.transform="translateX(-50%) scale(0.95)"}),console.log(`ğŸ¯ ALRA: Highlighted link #${t}: "${s.substring(0,50)}" (${(100*a).toFixed(0)}%)`)}(e,t+1),o.predictionsShown++}),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("âœ… ALRA: Phase 4 - Tab Prediction Complete"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log(`ğŸ”® Predictions generated: ${o.predictionsGenerated}`),console.log(`   Shown: ${o.predictionsShown}`),console.log(`   Avg confidence: ${(100*o.avgConfidence).toFixed(0)}%`),console.log(`   Patterns detected: ${o.patternsDetected}`),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),o}({enabled:!0,minPatternOccurrences:2,minConfidenceThreshold:.3,maxPredictionsShown:3,historyLookbackDays:7,updateIntervalMs:3e4,showInPopup:!0,highlightPredictedLinks:!0});if(e.predictionsGenerated>0)try{await q({action:"UPDATE_PHASE4_METRICS",data:{patternsDetected:e.patternsDetected,sequencesLearned:e.sequencesLearned,predictionsGenerated:e.predictionsGenerated,avgConfidence:e.avgConfidence,predictionsShown:e.predictionsShown,accuracy:e.accuracy}}),console.log("âœ… ALRA: Phase 4 metrics reported to background")}catch(e){console.debug("âš ï¸ ALRA: Could not report Phase 4 metrics",e)}}catch(e){console.error("âŒ ALRA: Phase 4 prediction initialization failed:",e),e instanceof Error&&(console.error("   Error message:",e.message),console.error("   Error stack:",e.stack))}}(),t.nudgesEnabled&&await async function(e){console.log("ğŸ’¡ ALRA: Phase 5 - Nudges (Available via FAB menu only)");const n={enabled:!1,minTimeOnPage:60,maxNudgesPerPage:2,autoHideAfter:10,position:"bottom-right"};try{await x(n,e.type,window.location.href)}catch(e){console.error("âš ï¸ ALRA: Nudge initialization failed",e)}}(i),t.metricsTrackingEnabled&&(document.addEventListener("scroll",()=>{S||(S=!0,console.log("âœ… ALRA: User started reading"))},{once:!0}),window.addEventListener("beforeunload",()=>{const e=Math.floor((Date.now()-T)/1e3);console.log("ğŸ“Š ALRA: User spent",e,"seconds on this page")})),function(){console.log("ğŸ‘ï¸ ALRA: Setting up interaction tracking...");let e=0,n=0,t=0,o=0;document.addEventListener("click",n=>{e++;const t=n.target;F()&&console.debug(`ğŸ“ ALRA: User clicked on: ${t.tagName}`,t.className)},!0),window.addEventListener("scroll",()=>{n++},{passive:!0}),document.addEventListener("mouseup",()=>{const e=window.getSelection()?.toString();e&&e.length>0&&(t++,console.log(`ğŸ“– ALRA: User selected text (${t} selections)`,e.substring(0,50)+"..."))}),document.addEventListener("mousemove",()=>{o++},{passive:!0});const a=setInterval(()=>{if(!F())return void clearInterval(a);const i=Math.floor((Date.now()-T)/1e3);chrome.runtime.sendMessage({action:"UPDATE_METRICS",data:{timeOnPageSeconds:i,userInteractions:e,scrollEvents:n,textSelections:t,mouseEvents:o,pageUrl:window.location.href,pageTitle:document.title}},e=>{chrome.runtime.lastError?clearInterval(a):e?.success&&console.debug("âœ… ALRA: Metrics updated in background script")})},3e4);window.addEventListener("beforeunload",()=>{if(!F())return;const o=Math.floor((Date.now()-T)/1e3);console.debug(`ğŸ“Š ALRA: Page session ended. Time: ${o}s, Interactions: ${e}, Scrolls: ${n}, Selections: ${t}`);try{chrome.runtime.sendMessage({action:"UPDATE_METRICS",data:{timeOnPageSeconds:o,userInteractions:e,scrollEvents:n,textSelections:t,totalEngagement:e+n+t,pageUrl:window.location.href,pageTitle:document.title,sessionEnded:!0}})}catch(e){}}),console.log("âœ… ALRA: Interaction tracking initialized")}(),console.log("âœ¨ ALRA: Fully initialized on this page!"),console.log(`ğŸ¯ ALRA: Available features: Optimization(${t.pageOptimizationEnabled}), Summarization(${t.summarizationEnabled}), Predictions(${t.predictionsEnabled}), Nudges(${t.nudgesEnabled}), Tracking(${t.metricsTrackingEnabled})`)}catch(e){console.debug("âš ï¸ ALRA: Error initializing (non-critical):",e)}}function q(e){return new Promise((n,t)=>{if(F())try{const o=setTimeout(()=>{t(new Error("Message response timeout - port may have closed"))},5e3);chrome.runtime.sendMessage(e,e=>{clearTimeout(o),chrome.runtime.lastError?t(chrome.runtime.lastError):n(e)})}catch(e){t(e)}else t(new Error("Extension context invalidated"))})}function D(){if(C)return;window.alraSummaryModal&&(R=window.alraSummaryModal,M=!0),L=new v,z=new w,I=new A,P=new k,$=new E,C=new f([{id:"summary",label:"AI Summary",icon:"âœ¨",action:()=>{R?R.show():alert("â³ Summary is being generated...\nPlease wait a moment and try again!")},badge:M?1:0},{id:"multimodal",label:"Multimodal AI",icon:"ğŸ¤–",action:async()=>{$&&await $.showQuickActions()}},{id:"metrics",label:"Productivity Stats",icon:"ğŸ“Š",action:async()=>{const e=await n.getMetrics();L&&L.show(e)}},{id:"nudges",label:"Smart Nudges",icon:"ğŸ’¡",action:async()=>{z&&await z.show()},badge:0},{id:"productivity",label:"Productivity Mode",icon:"ğŸ¯",action:async()=>{P&&await P.showSettings()}},{id:"sync",label:"Device Sync",icon:"ğŸ”„",action:async()=>{I&&await I.showSyncSettings()}},{id:"settings",label:"Extension Info",icon:"âš™ï¸",action:()=>{alert("ğŸ’¡ ALRA - AI Browser Assistant\n\nClick the extension icon in your toolbar for detailed stats!\n\nâœ¨ AI Summary\nğŸ¤– Multimodal AI (Image, Video, Text)\nğŸ“Š Productivity Stats\nğŸ’¡ Smart Nudges\nğŸ¯ Productivity Mode\nğŸ”„ Device Sync")}}]),console.log("ğŸ¯ ALRA: Floating menu initialized");const e=setInterval(()=>{window.alraSummaryAvailable&&!M&&(M=!0,R=window.alraSummaryModal,C?.updateBadge("summary",1),console.log("âœ… ALRA: Summary now available in menu!"),clearInterval(e))},1e3);setTimeout(()=>clearInterval(e),3e4)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{B(),t(),setTimeout(D,1e3)}):(B(),t(),setTimeout(D,1e3)),chrome.runtime.onMessage.addListener((e,n,t)=>{if("PAGE_LOADED"===e.action)return console.log("âœ… ALRA: Page loaded, optimizing..."),B().then(()=>t({success:!0})),!0})})();